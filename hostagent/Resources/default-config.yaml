# Default configuration for Haven Host Agent
port: 7090

# Default limit for collector runs when not specified in POST requests
default_limit: 1000

auth:
  header: x-auth
  secret: changeme  # CHANGE THIS IN PRODUCTION!

gateway:
  # HostAgent runs on macOS host, so use localhost:8085 to reach Gateway
  # (Gateway container exposes port 8085 to the host)
  base_url: http://localhost:8085
  ingest_path: /v1/ingest
  timeout: 30

logging:
  # Valid levels: trace, debug, info, notice, warning (or warn), error, critical (or fatal)
  # - Use lower-case strings. Some runtimes accept synonyms (warn/fatal).
  # - trace: very detailed diagnostics
  # - debug: verbose debugging information
  # - info: normal operational messages
  # - notice: higher-than-info (optional in some libs)
  # - warning/warn: unexpected but non-fatal
  # - error: operation failed; attention required
  # - critical/fatal: serious failure requiring immediate action
  level: info
  # Valid formats: json, text, logfmt
  # - json: structured JSON logs (default in this config)
  # - text: human-readable plain text logs
  # - logfmt: key=value pairs for compatibility with some log collectors
  # Use lower-case strings. Some runtimes accept additional custom formatters.
  format: json

modules:
  imessage:
    enabled: true
    ocr_enabled: true
    # chat_db_path: Path to chat.db (defaults to ~/Library/Messages/chat.db)
    # For development without Full Disk Access, copy chat.db to ~/.haven/chat.db
    # and set: chat_db_path: ~/.haven/chat.db
    # Or use environment variable: HAVEN_IMESSAGE_CHAT_DB_PATH=~/.haven/chat.db
    chat_db_path: ""  # Empty string uses system default
  
  ocr:
    enabled: true
    languages:
      - en
    timeout_ms: 2000
    recognition_level: fast  # Options: fast, accurate
    include_layout: true     # Include bounding boxes and language detection
  
  entity:
    enabled: true
    types:
      - person
      - organization
      - place
    min_confidence: 0.0  # Minimum confidence threshold (0.0-1.0)
  
  face:
    enabled: true
    min_face_size: 0.01       # Minimum face size as fraction of image (0.0-1.0) - 1% allows waist-up shots
    min_confidence: 0.7       # Minimum detection confidence (0.0-1.0)
    include_landmarks: false  # Include facial landmarks (eyes, nose, mouth)
  
  fswatch:
    enabled: false
    event_queue_size: 1000  # Maximum number of events to queue
    debounce_ms: 500        # Debounce interval for rapid file changes
    watches: []
      # Example watch configuration:
      # - id: downloads-watch
      #   path: /Users/username/Downloads
      #   glob: "*.{jpg,png,pdf}"
      #   target: gateway
      #   handoff: presigned
  
  localfs:
    enabled: false
    # default_watch_dir: ~/HavenInbox
    include:
      - "*.txt"
      - "*.md"
      - "*.pdf"
      - "*.png"
      - "*.jpg"
      - "*.jpeg"
      - "*.heic"
    exclude:
      - "*.tmp"
      - "~*"
    tags: []
    # move_to: ~/.haven/localfs/processed
    delete_after: false
    dry_run: false
    one_shot: true
    state_file: ~/.haven/localfs_collector_state.json
    max_file_bytes: 10485760
    request_timeout: 30
    follow_symlinks: false
  
  contacts:
    enabled: false
  
  calendar:
    enabled: false
  
  reminders:
    enabled: false
  
  mail:
    enabled: false
    # Module-level redaction default (applies to all sources unless overridden)
    redact_pii: true  # or false, or detailed object
    
    sources:
      # Local Mail.app source example
      - id: local-mailapp
        type: local
        enabled: false
        source_path: ~/Library/Mail/V10/
        redact_pii: false  # Override: don't redact for local
      
      # Remote IMAP source example
      - id: personal-icloud
        type: imap
        enabled: false
        host: imap.mail.me.com
        port: 993
        tls: true
        username: user@example.com
        auth:
          kind: app_password
          secret_ref: keychain://haven/icloud-mail
        folders:
          - INBOX
        redact_pii:  # Fine-grained override
          emails: false
          phones: true
          account_numbers: true
          ssn: true
    
    # Existing fields for local collector backward compat
    filters:
      # combination_mode: any | all (any = message accepted if any filter matches)
      combination_mode: any
      # default_action: include | exclude (applied when no filters present)
      default_action: include
      # Inline filters are embedded directly in the config file. Provide either
      # string expressions using the filter mini-language or structured objects.
      inline: []
      # Additional filter documents loaded from disk. Non-existent files are ignored.
      files:
        - ~/.haven/email_collector_filters.yaml
      # Environment variable that can supply a JSON/YAML filter definition.
      environment_variable: EMAIL_COLLECTOR_FILTERS
      # Optional pre-filter hints let the collector skip folders before deeper checks.
      prefilter:
        include_folders: []
        exclude_folders: []
        vip_only: false
        require_list_unsubscribe: false
    state:
      clear_on_new_run: true
      run_state_path: ~/.haven/email_collector_state_run.json
      rejected_log_path: ~/.haven/rejected_emails.log
      lock_file_path: ~/.haven/email_collector.lock
      rejected_retention_days: 30
  
  notes:
    enabled: false
