{"id":"hv-1","title":"Unit 9 (docs): README_poc.md â€” finalize after units 2/4/5/8","description":"Final POC README with 3â€“4 commands to run and verification steps. This task must wait until Units 2, 4, 5, and 8 are complete.","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-27T14:53:31.214582-04:00","updated_at":"2025-10-27T14:53:31.214582-04:00"}
{"id":"hv-10","title":"Publish Docs with MkDocs + Material","description":"## Summary\n\nCreate a first-class documentation system for Haven by introducing a `/docs/` folder and publishing a static site using **MkDocs** with the **Material** theme. Wire in an **API documentation section** that renders the project's OpenAPI spec as an interactive reference.\n\n## Goals\n\nCentralize product, architecture, and operations docs under `/docs/`.\nPublish a branded, searchable docs site with a stable URL.\nExpose the OpenAPI spec through an interactive UI with deep links and permalinks.\nAdopt a \"docs as code\" workflow with PR reviews.\n\n## Non-Goals\n\nMulti-version docs and i18n in v1.\nAutomated API client generation.\nCustom theming beyond Material configuration.\n\n## Scope\n\nAdd `/docs/` as the single source for narrative docs, guides, and runbooks.\nPublish to a static host (e.g., GitHub Pages) from `main`.\nInclude an **API** section that consumes an OpenAPI file from the repo and renders it as a browsable, searchable reference (tags, endpoints, schemas).\nEnsure dark/light mode, search, copy-code buttons, admonitions, and mobile navigation.\n\n## Information Architecture (initial)\n\n* `index.md` â€” Landing and key entry points.\n* `getting-started.md` â€” Quickstart for local preview and contributions.\n* `architecture/overview.md` â€” System context, key services, data flow.\n* `architecture/services.md` â€” Gateway, Catalog, Search, Embedding, Postgres, Qdrant, MinIO.\n* `operations/local-dev.md` â€” Local development environment basics.\n* `operations/deploy.md` â€” High-level deploy overview.\n* `contributing.md` â€” Authoring standards and review process.\n* `changelog.md` â€” Human-readable highlights.\n* `api/` â€” **OpenAPI documentation site** (see next section).\n\n## OpenAPI Documentation Wiring\n\nThe site must surface the project's OpenAPI spec (e.g., `/openapi/openapi.yaml` or `/openapi/openapi.json`) as an interactive API reference under `/api/`.\nThe API page must provide: tag navigation; operation details with request/response schemas; schema/model browsing; server/endpoint selection if defined; and stable deep links to operations and schemas.\nThe API reference must be generated at build time from the spec in the repo, so PRs that change the spec update the published reference automatically.\nIf multiple specs exist (e.g., `gateway`, `catalog`), the `/api/` section must list and route to each spec clearly (e.g., `/api/gateway/`, `/api/catalog/`).\nA \"Download spec\" link must be present for each exposed spec.\nDocument the canonical spec locations (e.g., `/openapi/gateway.yaml`, `/openapi/catalog.yaml`) and require that they remain valid for the build.\n\n## Deliverables\n\nA live docs site reachable at a stable URL.\n`/docs/` folder populated with the IA above.\n`mkdocs.yml` configured for Material theme, repo links, navigation, and search.\nAn `/api/` section that renders the OpenAPI spec(s) from the repo with interactive exploration and deep linking.\nA \"Documentation\" section in `README` that links to the site and explains how to preview docs locally and contribute via PRs.\n\n## Acceptance Criteria\n\nVisiting the site root shows the Material-styled landing page and working search.\nDark/light mode works, code blocks have copy buttons, and admonitions render correctly.\nThe `/api/` section loads the OpenAPI reference from the repo and supports tag filtering, operation details, schema browsing, and deep links that remain stable after rebuilds.\nChanges to `/docs/**`, `mkdocs.yml`, or `/openapi/**` result in an updated published site.\nThe API page(s) display a visible \"Download spec\" link that returns the exact spec version used to render the page.\n\n## Dependencies\n\nAn OpenAPI spec committed to the repo in a stable path.\nStatic hosting for the generated site and a CI workflow that publishes on merge to `main`.\n\n## Risks\n\nSpec drift or invalid OpenAPI will break the API page; mitigate with CI validation of the spec.\nDocs rot if authoring standards are unclear; mitigate with contributor guidance and PR templates.\n\n## Definition of Done\n\nDocs site is live at the chosen URL with the IA above.\nOpenAPI reference is interactive, up to date, and reachable at `/api/`.\nREADME links to the site and explains how to preview and contribute.\n\n## Takeaways\n\nThis establishes a durable \"docs as code\" foundation with strong UX and a first-class API reference tied to the repo's source of truth.\n\n## Next Steps\n\nConfirm canonical OpenAPI file paths and names.\nAdopt the IA and stub pages.\nEnable CI publish of the site and spec-driven API reference.","acceptance_criteria":"Subtasks created: haven-42 (Docs skeleton), haven-43 (OpenAPI integration), haven-44publish workflow), haven-45ME \u0026 contributing). See child tasks for implementation details and dependencies.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-27T14:55:40.586419-04:00","updated_at":"2025-10-27T14:55:40.586419-04:00"}
{"id":"hv-11","title":"README \u0026 Contributing: document docs preview and contribution process","description":"Update `README.md` with a \"Documentation\" section linking to the published docs and document how to preview the site locally and contribute docs via PRs. Include:\n\n- How to run locally (`pip install -r local_requirements.txt` + `mkdocs serve`)\n- How to add API spec changes and their CI validation\n- PR checklist for documentation changes\n\nAcceptance criteria:\n- `README.md` contains Documentation section and contribution instructions\n- PR template or checklist exists (can be a short file under `.github/ISSUE_TEMPLATE` or `docs/`)\n\nLabels: [\"type/task\",\"service/docs\",\"risk/low\",\"size/S\"]","status":"open","priority":3,"issue_type":"task","created_at":"2025-10-27T14:56:25.677651-04:00","updated_at":"2025-10-28T11:48:57.675323-04:00"}
{"id":"hv-12","title":"Unit 3: Hostagent POST /poc/crawl (threads/messages/extract)","description":"Add POC endpoint to hostagent for thread discovery, message extraction, and native NL processing","status":"open","priority":0,"issue_type":"task","created_at":"2025-10-27T14:56:26.435766-04:00","updated_at":"2025-10-28T11:48:57.675574-04:00"}
{"id":"hv-13","title":"Migrate repository to use uv + single pyproject.toml for env \u0026 package management","description":"Background:\nThe repository currently uses multiple requirement files (`requirements.txt`, `local_requirements.txt`) and per-environment workflows. We want to converge on `uv` (https://uvproject.io/) for environment and package management and a single `pyproject.toml` as the canonical project manifest. This will simplify local development, Docker builds, and CI across the monorepo.\n\nGoals:\n- Adopt `uv` for environment management and package installs.\n- Consolidate dependencies into a single `pyproject.toml` at repo root.\n- Ensure Dockerfile and `compose.yaml` builds use `pyproject.toml` and `uv`.\n- Provide documentation and migration notes for maintainers and contributors.\n\nAcceptance criteria:\n1. A beads issue exists documenting the migration plan, with clear labels and size.\n2. The repo has an entry in docs or `.tmp/migrate-to-uv.md` explaining developer steps to install and use `uv` locally.\n3. CI and Docker builds reference `pyproject.toml` and `uv` in at least one CI job or Docker build in a branch or PR (this bead may include follow-up tasks to update CI fully).\n4. Existing test suite runs successfully using the new environment on local machine (or documented blockers if any remain).\n5. Transition plan lists deprecated files and compat shims for a rollout.\n\nNotes:\n- Keep `requirements.txt` as a compatibility shim for Docker/CI until deployment is verified, but note in acceptance criteria when it can be removed.\n- Update `AGENTS.md` and `README.md` to mention `uv` where applicable.\n\nLabels: [\"service/devops\",\"type/task\",\"risk/med\",\"domain/developer-experience\"]\nPriority: 2\nSize: M","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:56:30.149828-04:00","updated_at":"2025-10-28T11:48:57.675815-04:00"}
{"id":"hv-14","title":"Add Google-style docstrings and API docs generation","description":"Add comprehensive Google-style docstrings across all Python files and add configuration/scripts to generate API documentation automatically.\n\nAcceptance criteria:\n- All public functions, classes, and modules in `src/`, `services/`, `shared/`, and `scripts/` have Google-style docstrings (summary, args, returns, raises, examples where appropriate).\n- A docs generation configuration is added using Sphinx (with napoleon) or MkDocs + mkdocstrings and can produce an API site.\n- A small README section describes how to run the docs generation locally (commands) and where generated docs live.\n- The bead includes suggested tooling, review checklist, and scope exclusions (tests, __pycache__, vendored code).\n\nSuggested size: M, priority: P1, labels: [\"type/task\",\"service/docs\",\"risk/low\"].\n\nNotes:\n- Recommend using Sphinx with napoleon extension for Google-style docstrings and autodoc, or MkDocs + mkdocstrings for a lighter setup. Include both options in the bead body so maintainers can choose.\n- Include script/Makefile targets to run the docs build.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:56:32.365885-04:00","updated_at":"2025-10-27T14:56:32.365885-04:00"}
{"id":"hv-15","title":"MKDocs integration notes for haven-52 (docstrings + mkdocs)","description":"Update to bead haven-52: ensure the docs generation work is incorporated into the repository's existing MkDocs site.\n\nChanges to include in bead body:\n\n1) mkdocs.yml edits\n- Add a top-level `nav` entry for `API` (or `Reference`) pointing to `api/index.md`.\n- Add `plugins` entries: `- search` and `- mkdocstrings`.\n- Example plugin config snippet:\n\nplugins:\n  - search\n  - mkdocstrings:\n      handlers:\n        python: {}\n\n2) requirements-docs.txt\n- Add the following packages to `requirements-docs.txt`:\n  - mkdocs\n  - mkdocs-material (optional)\n  - mkdocstrings\n  - pymdown-extensions\n  - mkdocs-autoreload (optional for local dev)\n\n3) docs/api/index.md\n- Add an example API page that uses mkdocstrings to document the project:\n\n  ## API Reference\n\n  ::: haven\n      handler: python\n\n  This will include the top-level package `haven`. You can also add targeted modules like `haven.shared`, `haven.services.gateway_api`, etc.\n\n4) Build target / script\n- Add a small script `scripts/build_docs_api.sh` or a Makefile target `docs-api`:\n\n  #!/usr/bin/env bash\n  set -euo pipefail\n  pip install -r requirements-docs.txt\n  mkdocs build\n\n- Optionally `mkdocs build -d site/` to place output where current `site/` expects.\n\n5) CI notes\n- Ensure CI job installs `requirements-docs.txt` and runs `mkdocs build`.\n\n6) Scope \u0026 exclusions\n- Document that tests, `__pycache__`, and vendor directories are excluded.\n\nPlease integrate these details into bead haven-52 so maintainers know exactly what to do and how to validate.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:56:35.498614-04:00","updated_at":"2025-10-27T14:56:35.498614-04:00"}
{"id":"hv-16","title":"HostAgent mail filters test fixtures fail to load","description":"Running `swift test` currently fails in `MailFiltersTests` because the YAML and JSON fixtures created on the fly are rejected by `MailFiltersLoader`. The suite reports assertion failures (expected include/exclude flags) and an `unsupportedFormat(\"Unable to parse filters from â€¦yaml\")` error when the loader reads temporary files. The failure is reproducible with `swift test --filter MailFiltersTests` and was observed while finishing haven-55.\n\nTasks:\n- Investigate the filter loader to ensure it accepts the serialized fixture format produced by the tests (likely missing schema/version headers or requiring stricter detection).\n- Adjust the loader or the fixture generator so inline JSON/YAML filters round-trip during tests.\n- Update tests/fixtures accordingly and re-enable full `swift test` runs.\n\nAcceptance:\n- `swift test --filter MailFiltersTests` passes locally.\n- Full `swift test` completes without MailFilters-related failures.\n\nNotes:\n- The failing tests are:\n  * `MailFiltersTests.testDSLParsingAndEvaluation`\n  * `MailFiltersTests.testEnvironmentJSONFilter`\n  * `MailFiltersTests.testAttachmentMimePredicate`\n  * `MailFiltersTests.testYAMLFileLoadingAndPrefilterMerge`\n- Error example: `unsupportedFormat(\"Unable to parse filters from /var/folders/.../temp.yaml\")`","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:57:06.665795-04:00","updated_at":"2025-10-28T11:48:57.676603-04:00"}
{"id":"hv-17","title":"Unit 4: Spanâ†’message offset mapping","description":"Map NL entity spans to message offsets for proper attribution","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-27T14:57:07.022511-04:00","updated_at":"2025-10-28T11:48:57.676845-04:00"}
{"id":"hv-18","title":"Remote IMAP Email Collector (epic): ephemeral .eml backfill \u0026 run-scoped cache","description":"Implement an IMAP-based remote collector (MailCore 2) that streams RFC822 bytes to ephemeral .eml files while running, hands them to the existing hostagent .eml/.emlx parser, and deletes the cache directory on exit. Support timeframe-batched backfill (newestâ†’older windows). No POP support.\n\nDesign \u0026 deliverables:\n1) IMAP Collector (Swift, MailCore 2): Async wrapper `ImapSession` around `MCOIMAPSession` exposing search and fetch APIs. Auth: pluggable for XOAUTH2 and app-password. Secrets resolved via Keychain `secret_ref`.\n\n2) Ephemeral Cache Manager: Run-scoped root directory (e.g., `~/.Caches/Haven/remote_mail/run-\u003ctimestamp\u003e-\u003cpid\u003e/`). Atomic write: `.eml.tmp` â†’ `*.eml` rename; parser consumes only finalized `.eml` files. Enforce `max_mb` (default 100MB) by evicting already-processed files (FIFO/LRU) and tracking on-disk size. Cleanup stale `run-*` dirs at startup and remove run dir on graceful exit.\n\n3) Backfill Engine: Time-window loop: start with `cursorEnd = now`, compute `cursorStart = cursorEnd - window_days`, then `SEARCH SINCE cursorStart BEFORE cursorEnd` to retrieve UIDs (newestâ†’oldest). Fetch RFC822 concurrently (bounded concurrency), write to cache, hand each finalized `.eml` to the existing `.eml/.emlx` parser, and delete or mark processed immediately after parser success to keep cache bounded. Stop when `cursorStart \u003c= stop_at`, or when `max_windows` or `max_messages` reached, or when search returns empty.\n\nAcceptance: 1) Resident cache never exceeds `max_mb` Â±5% when `max_mb: 100`; 2) After successful run, run dir fully removed; 3) iCloud IMAP backfill across 3 windows ingests messages newestâ†’older; 4) Folders with 500+ messages complete without OOM; 5) No POP code paths.","acceptance_criteria":"Added configuration scaffolding for the new mail_imap module, including defaults in hostagent.yaml, module reporting surfaces, and a validation guard that prevents enabling both modules.mail and modules.mail_imap simultaneously.","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2025-10-27T14:57:48.433238-04:00","updated_at":"2025-10-27T14:57:58.301153-04:00"}
{"id":"hv-19","title":"ImapSession: MailCore2 async wrapper (task)","description":"Implement an async Swift wrapper `ImapSession` around MailCore 2 (`MCOIMAPSession`) that exposes two primary async methods and pluggable auth for XOAUTH2 and app passwords.\n\nDeliverables:\n- `ImapSession` Swift type with: `searchMessages(folder: String, since: Date?, before: Date?) async throws -\u003e [UInt32]` and `fetchRFC822(folder: String, uid: UInt32) async throws -\u003e Data`\n- Auth support: XOAUTH2 and app-password; secrets resolved via Keychain `secret_ref`\n- Concurrency-safe implementation suitable for use by BackfillEngine\n- Unit tests covering search -\u003e fetch flow (mocked MailCore session)\n\nAcceptance: Methods implemented and documented; unit tests exist and pass; no POP code paths.\n\nKey additions: Add MailCore 2 dependency to hostagent's Swift package. Include smoke integration test. Document CI/build notes for MailCore setup.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-27T14:57:51.714928-04:00","updated_at":"2025-10-28T12:24:24.296835-04:00","closed_at":"2025-10-28T12:24:24.296835-04:00"}
{"id":"hv-2","title":"Epic: Finish Hostagent â€” build, run, test, and integrate","description":"Complete the Hostagent native macOS service so it can be built, installed, run as a LaunchAgent, collect iMessage/contact/fs data, perform Vision OCR, and integrate reliably with Gateway and Neo4j POC. Include tests and documentation.\n\nScope/Checklist:\n- Build and packaging: `make install`, `make run`, `make dev`, `make launchd` documented and working on macOS.\n- Collectors: iMessage, Contacts, localfs collectors updated to use hostagent API; deprecated Python collectors marked.\n- OCR/vision: integrate native Vision OCR endpoint `/v1/ocr` and replace legacy `imdesc.swift` usage.\n- FS watch: FSEvents-based uploads with presigned URL flows to Gateway/minio.\n- Gateway integration: Gateway POC routes (`/poc/hostagent/run`, `/poc/hostagent/status`) fully functional and tested end-to-end.\n- Neo4j POC: ensure hostagent-produced entities can be ingested into Gateway -\u003e Neo4j flow.\n- Tests: unit tests for hostagent logic, and an end-to-end smoke test that simulates collectors with `--simulate` and verifies Gateway ingestion.\n- Docs: `hostagent/QUICKSTART.md` and update `AGENTS.md` with final run instructions and TCC/FDA notes.\n\nAcceptance criteria:\n- Hostagent builds and installs locally on macOS via `make install`.\n- `make launchd` successfully installs a user LaunchAgent and `make health` returns 200.\n- End-to-end simulated collector run posts data to Gateway and the Gateway accepts it (200) in CI-like dry-run.\n- All new/changed functionality covered by unit tests; `pytest` passes for hostagent/test files.\n\nNotes:\n- This epic may depend on Units 2/4/5 for catalog/contact exports and span mapping for precise attribution.\n- Use existing `hostagent/Makefile` and follow `hostagent/QUICKSTART.md` conventions.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-27T14:53:35.882106-04:00","updated_at":"2025-10-27T14:53:35.882106-04:00"}
{"id":"hv-20","title":"EphemeralCache: run-scoped cache manager (task)","description":"Create the EphemeralCache manager used by the remote IMAP collector. The manager creates a run-scoped cache directory, writes `.eml.tmp` then `rename` to `.eml`, tracks on-disk size, enforces `max_mb` via eviction of already-processed files, and removes stale runs on startup.\n\nDeliverables: `EphemeralCache` Swift type (protocol + implementation) with methods: createRunDir, writeTemp, finalizeTemp, markProcessed, enforceSizeCap, cleanupOnExit, cleanupStaleRuns. Concurrency-safe (serial DispatchQueue or actor). Tempâ†’rename pattern.\n\nAcceptance: With `max_mb: 100`, cache keeps on-disk usage â‰¤100MB Â±5%; Run dir removed after normal run; Stale dirs removed at startup; Files written via *.eml.tmp and visible after rename; Processed files deleted to maintain cap.","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-27T14:57:55.094536-04:00","updated_at":"2025-10-27T14:57:55.094536-04:00"}
{"id":"hv-21","title":"Gateway: Provide per-account IMAP processed-state API and HostAgent integration","description":"Background:\nThe HostAgent IMAP run currently persists per-account+folder last-processed UIDs to a local file cache under the configured `mail_imap.cache.dir`. We want the Gateway to be the single source of truth for that state so multiple HostAgent instances (or other workers) can coordinate, and to avoid local-only state that is hard to inspect or migrate.\n\nGoal:\nAdd a Gateway-backed API and storage for the IMAP per-account processed-state, and update HostAgent to read/write that state from the Gateway instead of the local on-disk cache.\n\nScope:\n1. Gateway API: Add endpoints GET /v1/imap/state and POST/PUT /v1/imap/state. Persist state in Gateway DB (new table `imap_account_state`). Add migrations and index.\n2. Gateway backend: Storage adapter with unit tests for read/write semantics and auth.\n3. HostAgent changes: Remove local file-based state. Call Gateway GET at run start and POST/PUT after successful submissions. Add retry/backoff/fail-safe fallback.\n4. Tests \u0026 docs: Add unit tests for Gateway handlers and HostAgent changes. Update docs.\n\nAcceptance: Gateway exposes GET/PUT endpoints; HostAgent uses Gateway endpoints; safe fallback when Gateway unavailable; tests exist; docs updated.","acceptance_criteria":"1way DB schema created and migrations added.\n2. Gateway exposes GET and PUT/POST endpoints documented in OpenAPI.\n3. HostAgent uses GET at run start and PUT after successful submissions; tests verify behavior.4ostAgent falls back gracefully if Gateway unavailable and logs appropriate warnings.\n5. Docs updated.","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-27T14:59:19.755332-04:00","updated_at":"2025-10-27T14:59:19.755332-04:00"}
{"id":"hv-22","title":"Unit 5: Task heuristics + assignee + place merge (thread-scoped)","description":"Implement conversation-aware heuristics for task detection, assignee resolution, and place entity merging within thread context","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-27T14:59:20.577166-04:00","updated_at":"2025-10-28T11:48:57.678212-04:00"}
{"id":"hv-23","title":"Extract clean email body text and image captions (strip MIME/HTML cruft)","description":"Problem: Ingested emails currently carry raw MIME/html bodies which include styling, quoted replies, signatures, and other cruft. We need a standardized extraction that captures the meaningful plain-text body and any image captions.\n\nGoal: Implement an extractor that produces a cleaned plain-text body and a list of image captions. The extractor should run in the ingestion pipeline.\n\nDesign: Parse MIME with Python's email library. Prefer text/plain, convert html -\u003e text. Strip quoted reply/forward blocks. Extract image captions from alt attributes, figcaption, adjacent text, or OCR. Preserve language metadata. Keep idempotent and safe.\n\nAcceptance: Unit tests for parsing functions pass. Integration test verifies cleaned_body and image_captions exist after ingest. No regressions in existing ingest tests.","notes":"## Implementation Status - Swift Email Body Extraction\n\n### âœ… Completed Core Implementation\n- **SwiftSoup dependency added** to Package.swift for proper HTML parsing\n- **EmailBodyExtractor.swift created** with clean body text extraction:\n  - HTML to plain text conversion using SwiftSoup\n  - Quoted content stripping (text patterns like `\u003e`)\n  - Signature detection and removal\n  - HTML entity decoding\n- **EmailImageExtractor.swift created** with image caption extraction:\n  - HTML metadata extraction (alt text, figcaption, title attributes)\n  - OCR fallback integration with existing OCRService\n  - Protocol-based design for testability\n- **EmailDocumentMetadata updated** with `imageCaptions` and `bodyProcessed` fields\n- **EmailCollector integrated** to use new extractors, removed old stripHTML method\n- **Test fixtures created** with golden records for validation\n- **Unit tests implemented** for both extractors\n\n### ðŸ”§ Current Test Status\n**Tests Passing:** 6/11 (55%)\n- âœ… Plain text email processing\n- âœ… Quoted content stripping (text patterns)\n- âœ… Basic HTML to text conversion\n- âœ… Signature stripping\n- âœ… Malformed HTML handling\n- âœ… Empty body handling\n\n**Remaining Issues:**\n- HTML entity decoding needs refinement\n- HTML formatting preservation needs improvement\n- HTML blockquote stripping needs implementation\n- Some signature patterns need better detection\n\n### ðŸŽ¯ Key Design Decisions Implemented\n- SwiftSoup for proper HTML handling (better than regex)\n- Canonical cleaned body sent to gateway (raw content eliminated)\n- Combined image caption approach (HTML metadata + OCR fallback)\n- Protocol-based OCR integration for testability\n- Idempotent and safe fallback behavior\n\n### ðŸ“‹ Next Steps\n- Refine HTML entity decoding\n- Improve HTML formatting preservation\n- Implement HTML blockquote stripping\n- Enhance signature pattern detection\n- Complete integration testing","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-27T14:59:23.360698-04:00","updated_at":"2025-10-28T20:28:25.783369-04:00","closed_at":"2025-10-28T20:28:25.783369-04:00","comments":[{"id":1,"issue_id":"hv-23","author":"chrispatten","text":"Seems to be giving blank bodies. Need to add logging of before and after to evaluate.","created_at":"2025-10-28T03:59:22Z"}]}
{"id":"hv-24","title":"Unified Collector Run API (Normalizer + Router)","description":"Create a single Run API and a Normalizer+Router component in hostagent that owns `/v1/collectors/:name:run`, validates a unified JSON body, normalizes it to a shared DTO, routes to the correct collector adapter (imap, local_mail, imessage), and returns a standard response envelope.\n\nUnified Request includes mode, limit, batch_size, order, time_window, date_range, reset, concurrency, dry_run, source_overrides, credentials.\n\nStandard Response includes status, collector, run_id, started_at, finished_at, stats (scanned, matched, submitted, skipped, batches), warnings, errors.\n\nDeliverables: RunRouter.swift (HTTP handler), CollectorRunRequest.swift (DTO + validation), RunResponse.swift (envelope), adapters for each collector, JSON Schema, tests.\n\nAcceptance: Single route accepts unified body and rejects unknown fields; date_range overrides time_window; order honored; response uses standard envelope; tests pass.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-27T14:59:26.468212-04:00","updated_at":"2025-10-27T15:36:50.671105-04:00"}
{"id":"hv-25","title":"Tests: unit + end-to-end smoke for Run API and adapters","description":"Add tests for the Collector Run API and adapters.\n\nTests to add:\n- Unit tests for `CollectorRunRequest` decoding and schema rejections (unknown fields, bad enums).\n- Table-driven unit tests for each adapter mapping (IMAP, Local, iMessage) with golden req/resp.\n- Route-level end-to-end smoke tests for `/v1/collectors/:name:run` asserting standard response envelope, status, and stats.\n\nAcceptance criteria:\n- Tests added under `test/` and `tests/` as appropriate; CI should run them; provide example fixture files under `test/fixtures/collectors/`.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:59:27.859318-04:00","updated_at":"2025-10-27T14:59:27.859318-04:00"}
{"id":"hv-26","title":"Docs \u0026 examples: collectors_run_api.md + fixtures","description":"Add documentation and example fixtures for the unified collectors Run API.\n\nArtifacts:\n- `docs/hostagent/collectors_run_api.md` with schema overview, example requests/responses, and notes about concurrency clamp and date precedence.\n- Example fixtures in `test/fixtures/collectors/` (golden requests/responses for each collector and schema error examples).\n\nAcceptance criteria:\n- Docs page created and fixtures available for tests and developer reference.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:59:29.091168-04:00","updated_at":"2025-10-27T14:59:29.091168-04:00"}
{"id":"hv-27","title":"Clamp concurrency centrally in normalizer/DTO","description":"Implement central concurrency clamp (1..12) in the `CollectorRunRequest` normalizer so all adapters inherit the limit.\n\nTasks:\n- Enforce clamp during decode/normalization; if out of range, clamp and log a warning; tests for values \u003c1 and \u003e12.\n- Document behavior in `docs/hostagent/collectors_run_api.md`.\n\nAcceptance criteria:\n- Concurrency values are clamped and unit tests verify clamping and warning emission.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-27T14:59:30.395112-04:00","updated_at":"2025-10-27T15:22:20.490142-04:00","closed_at":"2025-10-27T15:22:20.490142-04:00"}
{"id":"hv-28","title":"CI / Quality gates: run tests \u0026 fix issues for Run API","description":"Run unit tests and CI checks for changes related to the unified Run API and ensure the codebase remains green.\n\nTasks:\n- Run `pytest` and fix any failing tests introduced by the new code.\n- Address linting/type errors in hostagent files touched.\n- Add CI job updates if needed to include new test fixtures.\n- Ensure commit messages include `Refs: beads:#haven-71` when landing PRs.\n\nAcceptance criteria:\n- Tests pass locally for the modified hostagent code; CI job(s) run and pass; any remaining failures documented with remediation steps.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:59:32.506376-04:00","updated_at":"2025-10-27T14:59:32.506376-04:00"}
{"id":"hv-29","title":"Test Issue","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.681765-04:00","updated_at":"2025-10-28T11:48:57.681765-04:00"}
{"id":"hv-3","title":"hostagent: validate \u0026 consolidate hostagent.yaml format","description":"Double-check, clean up, and consolidate the `hostagent.yaml` configuration format used by HostAgent. This task will: 1) review the current `.tmp/hostagent.bak.yaml` (provided by user) and any other hostagent config examples; 2) produce a single canonical `hostagent.yaml` schema (keys, types, defaults); 3) merge and clean duplicate/legacy keys; 4) add simple validation (schema or unit tests) and update docs so other contributors follow the canonical format.","design":"- Inspect `.tmp/hostagent.bak.yaml` and `hostagent/` config files for variations.\n- Propose canonical schema (YAML keys, types, defaults) in the bead body or a small design doc.\n- Implement schema file (e.g., `hostagent/hostagent.schema.yaml`) or unit tests under `test/` that validate example configs.\n- Update `docs/` (or create `.tmp/` doc) describing canonical format and migration notes.\n- Small follow-up PR to apply changes and add tests.","acceptance_criteria":"- Canonical `hostagent.yaml` schema documented and committed.\n- At least one unit test or schema validation that fails on an invalid sample and passes for the canonical sample.\n- Documentation updated with example config and migration steps.\n- Created PR referencing this bead and `Refs: beads:#\u003cid\u003e` on commit(s).","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:53:39.766338-04:00","updated_at":"2025-10-27T14:53:39.766338-04:00"}
{"id":"hv-30","title":"Unit 9 (docs): README_poc.md â€” finalize after units 2/4/5/8","description":"Final POC README with 3â€“4 commands to run and verification steps. This task must wait until Units 2, 4, 5, and 8 are complete.","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-27T21:32:30.99075-04:00","updated_at":"2025-10-28T11:48:57.680024-04:00"}
{"id":"hv-31","title":"Handle long running collector jobs better","description":"Long running collector jobs don't give any intermediate feedback to the caller. Think about different ways we could give the caller status or maybe do an async with a job queue","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-27T22:11:43.069254-04:00","updated_at":"2025-10-27T22:11:43.069254-04:00"}
{"id":"hv-32","title":"Support batch submissions from hostagent to gateway","description":"","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-27T22:19:23.115915-04:00","updated_at":"2025-10-27T22:19:23.115915-04:00"}
{"id":"hv-33","title":"Test Issue","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.169989-04:00","updated_at":"2025-10-27T23:59:22.229883-04:00"}
{"id":"hv-34","title":"HostAgent: Make collector polling intervals configurable (iMessage, LocalFS, Contacts)","description":"Add configuration and runtime controls to set polling intervals for HostAgent collectors (iMessage, LocalFS, Contacts, and any future collectors).\\n\\nBackground:\\nHostAgent currently runs collectors on fixed schedules. Operators need the ability to tune polling frequency per-collector to balance CPU/IO, battery, and timeliness. This task adds config, runtime endpoints, and documentation.\\n\\nAcceptance criteria:\\n- Add per-collector polling interval configuration via: 1) `hostagent.yaml` config file (per-collector keys), 2) environment variables `HOSTAGENT_\u003cCOLLECTOR\u003e_POLL_INTERVAL_SEC`, and 3) CLI flags for simulate/test runs.\\n- Implement runtime endpoints: `GET /v1/collectors/{collector}/poll_interval` and `POST /v1/collectors/{collector}/poll_interval` to view and update the interval without restart. POST accepts `{ \"interval_seconds\": \u003cnumber\u003e }` and validates min/max bounds.\\n- Ensure iMessage, LocalFS, and Contacts collectors read the effective interval and apply it for scheduling/backoff; new collectors should reuse the same scheduling helper.\\n- Validate that changes via environment, config file, and runtime API follow this precedence: API update \u003e env var \u003e config file \u003e default (60s). Document this precedence in `AGENTS.md` and `hostagent/QUICKSTART.md`.\n- Add unit tests for scheduling helper and integration tests that simulate changing the poll interval at runtime and confirm the collector respects the new interval within one cycle.\n- Add labels: `service/hostagent`, `type/task`, `risk/low`, `priority:P2`.\n\\nNotes:\\n- Use sensible min/max (min 5s, max 86400s = 1 day) and defensive validation.\\n- Prefer a small, shared scheduling utility that emits schedule ticks and supports update at runtime and backoff.\\n- Keep changes backwards compatible; default behavior remains current schedule if no config provided.\\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.170445-04:00","updated_at":"2025-10-27T23:59:22.234482-04:00"}
{"id":"hv-35","title":"Add Google-style docstrings and API docs generation","description":"Add comprehensive Google-style docstrings across all Python files and add configuration/scripts to generate API documentation automatically.\n\nAcceptance criteria:\n- All public functions, classes, and modules in `src/`, `services/`, `shared/`, and `scripts/` have Google-style docstrings (summary, args, returns, raises, examples where appropriate).\n- A docs generation configuration is added using Sphinx (with napoleon) or MkDocs + mkdocstrings and can produce an API site.\n- A small README section describes how to run the docs generation locally (commands) and where generated docs live.\n- The bead includes suggested tooling, review checklist, and scope exclusions (tests, __pycache__, vendored code).\n\nSuggested size: M, priority: P1, labels: [\"type/task\",\"service/docs\",\"risk/low\"].\n\nNotes:\n- Recommend using Sphinx with napoleon extension for Google-style docstrings and autodoc, or MkDocs + mkdocstrings for a lighter setup. Include both options in the bead body so maintainers can choose.\n- Include script/Makefile targets to run the docs build.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.170752-04:00","updated_at":"2025-10-27T23:59:22.222465-04:00"}
{"id":"hv-36","title":"MKDocs integration notes for haven-52 (docstrings + mkdocs)","description":"Update to bead haven-52: ensure the docs generation work is incorporated into the repository's existing MkDocs site.\n\nChanges to include in bead body:\n\n1) mkdocs.yml edits\n- Add a top-level `nav` entry for `API` (or `Reference`) pointing to `api/index.md`.\n- Add `plugins` entries: `- search` and `- mkdocstrings`.\n- Example plugin config snippet:\n\nplugins:\n  - search\n  - mkdocstrings:\n      handlers:\n        python: {}\n\n2) requirements-docs.txt\n- Add the following packages to `requirements-docs.txt`:\n  - mkdocs\n  - mkdocs-material (optional)\n  - mkdocstrings\n  - pymdown-extensions\n  - mkdocs-autoreload (optional for local dev)\n\n3) docs/api/index.md\n- Add an example API page that uses mkdocstrings to document the project:\n\n  ## API Reference\n\n  ::: haven\n      handler: python\n\n  This will include the top-level package `haven`. You can also add targeted modules like `haven.shared`, `haven.services.gateway_api`, etc.\n\n4) Build target / script\n- Add a small script `scripts/build_docs_api.sh` or a Makefile target `docs-api`:\n\n  #!/usr/bin/env bash\n  set -euo pipefail\n  pip install -r requirements-docs.txt\n  mkdocs build\n\n- Optionally `mkdocs build -d site/` to place output where current `site/` expects.\n\n5) CI notes\n- Ensure CI job installs `requirements-docs.txt` and runs `mkdocs build`.\n\n6) Scope \u0026 exclusions\n- Document that tests, `__pycache__`, and vendor directories are excluded.\n\nPlease integrate these details into bead haven-52 so maintainers know exactly what to do and how to validate.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.171008-04:00","updated_at":"2025-10-27T23:59:22.222945-04:00"}
{"id":"hv-37","title":"Add OpenAPI exporter endpoint to HostAgent runtime","description":"Goal\nAdd a canonical, runtime OpenAPI exporter to the HostAgent Swift service so the service can serve its OpenAPI spec (JSON and/or YAML) and be the single source-of-truth for API docs. This will eliminate spec drift and allow automation (mkdocs/exporter) to fetch the live spec during docs builds or CI.\n\nBackground\nCurrently the repo contains a static `openapi/hostagent.yaml` authored by hand and a Python exporter that writes a Redoc page for it. HostAgent is a macOS-native Swift service; there is no runtime OpenAPI endpoint. That produces drift risk when new routes or request/response schemas are added in Swift.\n\nScope\n- Add an endpoint to HostAgent that exposes the service's OpenAPI specification at `/openapi.json` and `/openapi.yaml` (YAML optional). The endpoint should be enabled in dev/build configurations and guarded behind admin or local-only access in production if required by config.\n- Generate OpenAPI programmatically from the HostAgent router/handlers and bundled JSON schemas in `Resources/*/schemas/*.schema.json` (merge those into components.schemas). If full programmatic generation is infeasible, provide a build-time task that composes the OpenAPI spec from route metadata + JSON schemas and writes a file to `Resources/OpenAPI/hostagent.yaml` that the server serves statically.\n- Ensure the exporter includes the Collector routes, email utilities, FSWatch, face detection, OCR, entities, modules, metrics, and health endpoints already present in the router.\n- Add minimal tests that exercise the endpoint and verify the presence of key paths and the `CollectorRunRequest` schema in components.\n- Update docs/dev workflow: the Python `scripts/export_openapi.py` (or docs hooks) can optionally fetch the runtime `/openapi.yaml` (if server running) or read the build-time generated `Resources/OpenAPI/hostagent.yaml` during docs builds/CI.\n\nDesign notes\n- Runtime approach (preferred long-term): implement a small OpenAPI-builder utility in Swift that walks the Router/PatternRouteHandler registrations and collects path patterns, methods, and handler metadata. For each route, include a path entry with sensible default request/response schemas, and resolve component schemas by importing JSON schema files from Resources.\n  - Expose endpoints: `/openapi.json` and `/openapi.yaml` (Content-Type application/json / application/x-yaml).\n  - Add a config toggle: `openapi.enabled: true|false`, default true in dev, false in production unless explicitly enabled.\n  - Secure the endpoint optionally with the hostagent auth header (configurable) or limit to localhost only.\n\n- Build-time fallback (lower risk): add a Swift PackageTarget/tool that generates `Resources/OpenAPI/hostagent.yaml` from the same route discovery utility and schema files. Add a Makefile or SPM run target `swift run hostagent-openapi --emit-resources` to write the file into `Resources/OpenAPI/` which will be bundled and served as static files.\n\nAcceptance criteria\n- The HostAgent binary serves an OpenAPI spec at `/openapi.yaml` when `openapi.enabled` is true (or the generated resource file exists). The spec includes paths for collectors (including `imessage` and `email_imap`) and contains `components.schemas.CollectorRunRequest` matching the JSON schema in `Resources/Collectors/schemas/collector_run_request.schema.json`.\n- Unit/integration test that makes a local request to `/openapi.yaml` and asserts the spec contains `/v1/collectors/imessage:run` and `components.schemas.CollectorRunRequest`.\n- `scripts/export_openapi.py` can optionally be updated to fetch the runtime `/openapi.yaml` (if server available) during docs builds â€” documented in the README/dev docs.\n\nImplementation tasks\n1. Add a new Swift module `HostOpenAPI` or utility inside HostAgent to build the spec.\n2. Implement route-walker that introspects `Router` / `PatternRouteHandler` registrations.\n3. Merge JSON schemas from `Resources/**/schemas/*.schema.json` into `components.schemas`.\n4. Expose endpoints `/openapi.json` and `/openapi.yaml` (serve YAML by converting internal JSON using a YAML serializer or pre-generate YAML at build time).\n5. Add config flag to enable/disable endpoint and optional local-only/auth restrictions.\n6. Add tests covering presence of key paths and schemas.\n7. Optional: update `scripts/export_openapi.py` doc/comments to support fetching runtime spec.\n\nNotes / Risks\n- Programmatic route introspection in Swift depends on the router implementation. If introspection is not possible, the build-time generator fallback will be used.\n- Care must be taken to not leak sensitive data (authentication headers, internal endpoints). Default to local-only in production.\n\nEstimate\n- Design + prototype: 1â€“2 days\n- Implementation + tests + docs: 2â€“4 days\n\n","design":"See description above for runtime vs build-time designs. Prefer runtime exporter with config toggle; fallback to build-time generator if introspection is impractical.","acceptance_criteria":"- HostAgent serves /openapi.yaml when enabled.\n- The YAML contains `/v1/collectors/imessage:run` and `components.schemas.CollectorRunRequest` matching the repo JSON schema.\n- Tests added and passing.\n- Docs updated to describe how to fetch the runtime spec and how mkdocs/docs exporter can use it.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-27T23:59:22.171283-04:00","updated_at":"2025-10-27T23:59:22.232198-04:00"}
{"id":"hv-38","title":"hostagent: validate \u0026 consolidate hostagent.yaml format","description":"Double-check, clean up, and consolidate the `hostagent.yaml` configuration format used by HostAgent. This task will: 1) review the current `.tmp/hostagent.bak.yaml` (provided by user) and any other hostagent config examples; 2) produce a single canonical `hostagent.yaml` schema (keys, types, defaults); 3) merge and clean duplicate/legacy keys; 4) add simple validation (schema or unit tests) and update docs so other contributors follow the canonical format.","design":"- Inspect `.tmp/hostagent.bak.yaml` and `hostagent/` config files for variations.\n- Propose canonical schema (YAML keys, types, defaults) in the bead body or a small design doc.\n- Implement schema file (e.g., `hostagent/hostagent.schema.yaml`) or unit tests under `test/` that validate example configs.\n- Update `docs/` (or create `.tmp/` doc) describing canonical format and migration notes.\n- Small follow-up PR to apply changes and add tests.","acceptance_criteria":"- Canonical `hostagent.yaml` schema documented and committed.\n- At least one unit test or schema validation that fails on an invalid sample and passes for the canonical sample.\n- Documentation updated with example config and migration steps.\n- Created PR referencing this bead and `Refs: beads:#\u003cid\u003e` on commit(s).","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.171555-04:00","updated_at":"2025-10-27T23:59:22.231737-04:00"}
{"id":"hv-4","title":"POC: Hostagent â†’ Gateway â†’ Neo4j (Life Graph)","description":"Stand up Neo4j in compose, add Gateway POC routes, call Hostagent for iMessage crawl (N/X days), run native extraction \u0026 merges, idempotent upsert to Neo4j, provide validation queries.","status":"open","priority":0,"issue_type":"epic","created_at":"2025-10-27T14:53:58.679528-04:00","updated_at":"2025-10-28T08:56:38.221494-04:00"}
{"id":"hv-44","title":"Tests: unit + end-to-end smoke for Run API and adapters","description":"Add tests for the Collector Run API and adapters.\n\nTests to add:\n- Unit tests for `CollectorRunRequest` decoding and schema rejections (unknown fields, bad enums).\n- Table-driven unit tests for each adapter mapping (IMAP, Local, iMessage) with golden req/resp.\n- Route-level end-to-end smoke tests for `/v1/collectors/:name:run` asserting standard response envelope, status, and stats.\n\nAcceptance criteria:\n- Tests added under `test/` and `tests/` as appropriate; CI should run them; provide example fixture files under `test/fixtures/collectors/`.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.172998-04:00","updated_at":"2025-10-27T23:59:22.227291-04:00"}
{"id":"hv-45","title":"Docs \u0026 examples: collectors_run_api.md + fixtures","description":"Add documentation and example fixtures for the unified collectors Run API.\n\nArtifacts:\n- `docs/hostagent/collectors_run_api.md` with schema overview, example requests/responses, and notes about concurrency clamp and date precedence.\n- Example fixtures in `test/fixtures/collectors/` (golden requests/responses for each collector and schema error examples).\n\nAcceptance criteria:\n- Docs page created and fixtures available for tests and developer reference.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.173216-04:00","updated_at":"2025-10-27T23:59:22.228219-04:00"}
{"id":"hv-46","title":"Clamp concurrency centrally in normalizer/DTO","description":"Implement central concurrency clamp (1..12) in the `CollectorRunRequest` normalizer so all adapters inherit the limit.\n\nTasks:\n- Enforce clamp during decode/normalization; if out of range, clamp and log a warning; tests for values \u003c1 and \u003e12.\n- Document behavior in `docs/hostagent/collectors_run_api.md`.\n\nAcceptance criteria:\n- Concurrency values are clamped and unit tests verify clamping and warning emission.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.175758-04:00","updated_at":"2025-10-27T23:59:22.229014-04:00"}
{"id":"hv-47","title":"CI / Quality gates: run tests \u0026 fix issues for Run API","description":"Run unit tests and CI checks for changes related to the unified Run API and ensure the codebase remains green.\n\nTasks:\n- Run `pytest` and fix any failing tests introduced by the new code.\n- Address linting/type errors in hostagent files touched.\n- Add CI job updates if needed to include new test fixtures.\n- Ensure commit messages include `Refs: beads:#haven-71` when landing PRs.\n\nAcceptance criteria:\n- Tests pass locally for the modified hostagent code; CI job(s) run and pass; any remaining failures documented with remediation steps.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.176275-04:00","updated_at":"2025-10-27T23:59:22.229494-04:00"}
{"id":"hv-49","title":"Hostagent: Port macOS Contacts collector (collector_contacts.py) to Swift","description":"Port the Python Contacts collector (`scripts/collectors/collector_contacts.py`) into the native Hostagent Swift service as a collector endpoint.\n\nScope/Tasks:\n- Add `POST /v1/collectors/contacts:run` and `GET /v1/collectors/contacts/state` endpoints in hostagent.\n- Implement safe access to macOS Contacts (CNContactStore) and mapping to the existing PersonIngestRecord/gateway schema.\n- Implement batching and backoff to POST to Gateway `/catalog/contacts/ingest` (support simulate mode for CI).\n- Add option to run in `simulate` mode (no FDA required), and a `limit` parameter for testing.\n- Handle photo hashing (SHA256) and label localization (reusing `localizedStringForLabel:` like the Python version).\n- Add robust error handling and state persistence to `~/.haven/contacts_collector_state.json`.\n- Add unit tests and fixtures (small set of representative contacts) and update `hostagent/QUICKSTART.md` and `AGENTS.md` with the new endpoints.\n\nAcceptance Criteria:\n- `POST /v1/collectors/contacts:run` returns valid JSON with `status` and `people` when run in simulate mode.\n- Hostagent can run mount-based collection with FDA when run locally and return full person records matching current Python collector schema.\n- Batching to Gateway works and respects `CONTACTS_BATCH_SIZE` env var; use backoff/retries on transient HTTP errors.\n- Unit tests exercise parsing logic and photo hash computation.\n\nNotes:\n- The script `scripts/collectors/collector_contacts.py` is attached in the issue for reference.\n- Label this task `service/hostagent`, `type/task`, `risk/med`.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T23:59:22.177389-04:00","updated_at":"2025-10-27T23:59:22.233942-04:00"}
{"id":"hv-5","title":"Add OpenAPI exporter endpoint to HostAgent runtime","description":"Goal\nAdd a canonical, runtime OpenAPI exporter to the HostAgent Swift service so the service can serve its OpenAPI spec (JSON and/or YAML) and be the single source-of-truth for API docs. This will eliminate spec drift and allow automation (mkdocs/exporter) to fetch the live spec during docs builds or CI.\n\nBackground\nCurrently the repo contains a static `openapi/hostagent.yaml` authored by hand and a Python exporter that writes a Redoc page for it. HostAgent is a macOS-native Swift service; there is no runtime OpenAPI endpoint. That produces drift risk when new routes or request/response schemas are added in Swift.\n\nScope\n- Add an endpoint to HostAgent that exposes the service's OpenAPI specification at `/openapi.json` and `/openapi.yaml` (YAML optional). The endpoint should be enabled in dev/build configurations and guarded behind admin or local-only access in production if required by config.\n- Generate OpenAPI programmatically from the HostAgent router/handlers and bundled JSON schemas in `Resources/*/schemas/*.schema.json` (merge into components.schemas). If full programmatic generation is infeasible, provide a build-time task that composes the OpenAPI spec from route metadata + JSON schemas and writes a file to `Resources/OpenAPI/hostagent.yaml` that the server serves statically.\n- Ensure the exporter includes the Collector routes, email utilities, FSWatch, face detection, OCR, entities, modules, metrics, and health endpoints already present in the router.\n- Add minimal tests that exercise the endpoint and verify the presence of key paths and the `CollectorRunRequest` schema in components.\n- Update docs/dev workflow: the Python `scripts/export_openapi.py` (or docs hooks) can optionally fetch the runtime `/openapi.yaml` (if server running) or read the build-time generated `Resources/OpenAPI/hostagent.yaml` during docs builds/CI.\n\nDesign notes\n- Runtime approach (preferred long-term): implement a small OpenAPI-builder utility in Swift that walks the Router/PatternRouteHandler registrations and collects path patterns, methods, and handler metadata. For each route, include a path entry with sensible default request/response schemas, and resolve component schemas by importing JSON schema files from Resources.\n  - Expose endpoints: `/openapi.json` and `/openapi.yaml` (Content-Type application/json / application/x-yaml).\n  - Add a config toggle: `openapi.enabled: true|false`, default true in dev, false in production unless explicitly enabled.\n  - Secure the endpoint optionally with the hostagent auth header (configurable) or limit to localhost only.\n\n- Build-time fallback (lower risk): add a Swift PackageTarget/tool that generates `Resources/OpenAPI/hostagent.yaml` from the same route discovery utility and schema files. Add a Makefile or SPM run target `swift run hostagent-openapi --emit-resources` to write the file into `Resources/OpenAPI/` which will be bundled and served as static files.\n\nAcceptance criteria\n- The HostAgent binary serves an OpenAPI spec at `/openapi.yaml` when `openapi.enabled` is true (or the generated resource file exists). The spec includes paths for collectors (including `imessage` and `email_imap`) and contains `components.schemas.CollectorRunRequest` matching the JSON schema in `Resources/Collectors/schemas/collector_run_request.schema.json`.\n- Unit/integration test that makes a local request to `/openapi.yaml` and asserts the spec contains `/v1/collectors/imessage:run` and `components.schemas.CollectorRunRequest`.\n- `scripts/export_openapi.py` can optionally be updated to fetch the runtime `/openapi.yaml` (if server available) during docs builds â€” documented in the README/dev docs.\n\nImplementation tasks\n1. Add a new Swift module `HostOpenAPI` or utility inside HostAgent to build the spec.\n2. Implement route-walker that introspects `Router` / `PatternRouteHandler` registrations.\n3. Merge JSON schemas from `Resources/**/schemas/*.schema.json` into `components.schemas`.\n4. Expose endpoints `/openapi.json` and `/openapi.yaml` (serve YAML by converting internal JSON using a YAML serializer or pre-generate YAML at build time).\n5. Add config flag to enable/disable endpoint and optional local-only/auth restrictions.\n6. Add tests covering presence of key paths and schemas.\n7. Optional: update `scripts/export_openapi.py` doc/comments to support fetching runtime spec.\n\nNotes / Risks\n- Programmatic route introspection in Swift depends on the router implementation. If introspection is not possible, the build-time generator fallback will be used.\n- Care must be taken to not leak sensitive data (authentication headers, internal endpoints). Default to local-only in production.\n\nEstimate\n- Design + prototype: 1â€“2 days\n- Implementation + tests + docs: 2â€“4 days","design":"See description above for runtime vs build-time designs. Prefer runtime exporter with config toggle; fallback to build-time generator if introspection is impractical.","acceptance_criteria":"- HostAgent serves /openapi.yaml when enabled.\n- The YAML contains `/v1/collectors/imessage:run` and `components.schemas.CollectorRunRequest` matching the repo JSON schema.\n- Tests added and passing.\n- Docs updated to describe how to fetch the runtime spec and how mkdocs/docs exporter can use it.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-27T14:54:03.81273-04:00","updated_at":"2025-10-27T14:54:03.81273-04:00"}
{"id":"hv-55","title":"Add blockquote element removal in convertToPlainText()","description":"Use SwiftSoup to select and remove `\u003cblockquote\u003e` elements before text extraction in the convertToPlainText() method. Add this alongside existing script/style removal around line 63.","acceptance_criteria":"testStripHTMLBlockquotes test passes - blockquote content is removed from HTML emails","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-28T09:02:57.785263-04:00","updated_at":"2025-10-28T09:08:44.523666-04:00","closed_at":"2025-10-28T09:08:44.523666-04:00"}
{"id":"hv-56","title":"Improve newline handling between block elements for proper formatting","description":"Fix HTML formatting preservation by adding proper newlines after headings, paragraphs, and divs. Ensure figcaption and image alt text are formatted with labels and newlines. Current issue: block elements are concatenated without spacing.","acceptance_criteria":"testHTMLWithImagesGoldenRecord test passes - output matches golden record with proper newlines between elements","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-28T09:03:01.051626-04:00","updated_at":"2025-10-28T09:52:11.172785-04:00","closed_at":"2025-10-28T09:52:11.172785-04:00"}
{"id":"hv-57","title":"Ensure HTML entities are properly decoded during text extraction","description":"Fix HTML entity decoding for \u0026nbsp;, \u0026lt;, \u0026gt;, \u0026amp;. Investigate if DOM manipulation before .text() call breaks SwiftSoup's entity decoding. Either call .text() earlier or apply manual decodeHTMLEntities() after extraction.","acceptance_criteria":"testHTMLWithEntities test passes - HTML entities are properly decoded to their character equivalents","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-28T09:03:03.946847-04:00","updated_at":"2025-10-28T09:58:45.239877-04:00","closed_at":"2025-10-28T09:58:45.239877-04:00"}
{"id":"hv-58","title":"Refine signature stripping to preserve sign-off text before delimiters","description":"Fix signature detection to keep job titles and company names that appear before the '--' delimiter. Only remove content after signature delimiters. Current issue: 'Senior Developer' and 'Acme Corporation' are incorrectly removed.","acceptance_criteria":"testStripSignature test passes - keeps sign-off and contact info before delimiter, removes only post-delimiter signature content","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-28T09:03:06.539308-04:00","updated_at":"2025-10-28T10:04:11.449212-04:00","closed_at":"2025-10-28T10:04:11.449212-04:00"}
{"id":"hv-59","title":"Debug and fix quoted content stripping in mixed HTML/text content","description":"Fix quoted content stripping when plain text contains embedded HTML tags mixed with quoted lines. Verify stripQuotedContent() properly handles lines starting with '\u003e' in mixed content scenarios.","acceptance_criteria":"testMixedContent test passes - quoted content lines are removed even when mixed with HTML","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-28T09:03:08.554713-04:00","updated_at":"2025-10-28T10:28:40.36789-04:00","closed_at":"2025-10-28T10:28:40.36789-04:00"}
{"id":"hv-6","title":"Hostagent: Complete FS watch endpoints","description":"Finish FSEvents-based file system watch implementation with presigned URL uploads.\n\nTasks:\n- Complete POST /v1/fs-watches endpoint (register new watch)\n- Complete GET /v1/fs-watches (list active watches)\n- Complete DELETE /v1/fs-watches/{id} (remove watch)\n- Complete GET /v1/fs-watches/events (poll event queue)\n- Complete POST /v1/fs-watches/events:clear (clear queue)\n- Implement FSEvents watcher that detects file changes in monitored directories\n- Integrate with Gateway to request presigned URLs for uploads\n- Upload files to minio via presigned URLs when changes detected\n- Add proper error handling for permission issues, missing directories\n\nAcceptance:\n- Can register a watch on ~/Documents and see file change events\n- Events include file path, event type (created/modified/deleted), timestamp\n- Files are uploaded to minio via presigned URLs\n- Watch state persists across hostagent restarts (if needed)","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:55:23.700574-04:00","updated_at":"2025-10-28T11:48:57.680949-04:00"}
{"id":"hv-60","title":"Unify mail config and add PII redaction options","description":"Consolidate modules.mail and modules.mail_imap into a unified modules.mail.sources configuration structure. Add configurable PII redaction support with module-level defaults and per-source overrides. Keep local collector code functional but deprecated for now.","design":"New config structure:\n- modules.mail.sources[] - array of IMAP sources (extensible for future POP/etc)\n- modules.mail.redact_pii - module-level redaction (true/false/object)\n- per-source redact_pii override\n\nRedaction config:\n- true: redact all PII types\n- false: disable all redaction  \n- {emails: bool, phones: bool, account_numbers: bool, ssn: bool}: fine-grained\n\nResolution order: source override \u003e module default \u003e true\n\nBackward compatibility:\n- Decoder migrates mail_imap to mail.sources automatically\n- Logs deprecation warnings for old config\n- Keeps source_path for local collector (phase 2 removal)","acceptance_criteria":"- Config.swift defines RedactionConfig enum, MailSourceConfig struct, updated MailModuleConfig\n- EmailService.redactPII() accepts RedactionOptions and conditionally redacts based on flags\n- EmailCollector resolves effective redaction from source/module config\n- EmailImapHandler reads from config.modules.mail.sources\n- default-config.yaml shows unified structure with examples\n- Tests validate: config migration, redaction resolution, each redaction type can be toggled\n- Documentation updated: email-utilities.md, email-imap-collector.md\n- Existing configs auto-migrate without breaking","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-28T11:47:41.791391-04:00","updated_at":"2025-10-28T12:19:33.605322-04:00","closed_at":"2025-10-28T12:19:33.605322-04:00"}
{"id":"hv-61","title":"Remove legacy local mail collector code","description":"Delete all local mail collector implementation files, tests, and documentation. Clean up package dependencies and remove deprecated configuration fields. IMAP-only mail collection after this change.","design":"Files to delete:\n- EmailLocalHandler.swift\n- EmailIndexedCollector.swift  \n- EmailLocalHandlerTests.swift\n- EmailIndexedCollectorTests.swift\n- docs/hostagent/email-local-collector.md\n- docs/guides/email-collector.md\n\nConfig cleanup:\n- Remove source_path from MailModuleConfig\n- Remove any local-specific validation\n- Update decoder to warn if source_path detected\n\nPackage cleanup:\n- Remove local collector dependencies from Package.swift\n- Clean up imports in remaining files\n\nRoute cleanup:\n- Remove any email_local routes from main.swift","acceptance_criteria":"- All local collector files deleted\n- No references to EmailLocalHandler or EmailIndexedCollector in codebase\n- source_path field removed from Config.swift\n- Package.swift has no local-collector-only dependencies\n- No email_local routes in main.swift\n- Documentation updated: README.md, AGENTS.md, guides/README.md have no local collector references\n- Build succeeds with no warnings\n- All tests pass","status":"open","priority":2,"issue_type":"chore","created_at":"2025-10-28T11:47:52.167887-04:00","updated_at":"2025-10-28T11:47:52.167887-04:00"}
{"id":"hv-62","title":"POC: Hostagent â†’ Gateway â†’ Neo4j (Life Graph)","description":"Stand up Neo4j in compose, add Gateway POC routes, call Hostagent for iMessage crawl (N/X days), run native extraction \u0026 merges, idempotent upsert to Neo4j, provide validation queries.","status":"open","priority":0,"issue_type":"epic","created_at":"2025-10-28T11:48:57.637219-04:00","updated_at":"2025-10-28T11:48:57.674619-04:00"}
{"id":"hv-63","title":"Publish Docs with MkDocs + Material","description":"## Summary\n\nCreate a first-class documentation system for Haven by introducing a `/docs/` folder and publishing a static site using **MkDocs** with the **Material** theme. Wire in an **API documentation section** that renders the projectâ€™s OpenAPI spec as an interactive reference.\n\n## Goals\n\nCentralize product, architecture, and operations docs under `/docs/`.\nPublish a branded, searchable docs site with a stable URL.\nExpose the OpenAPI spec through an interactive UI with deep links and permalinks.\nAdopt a â€œdocs as codeâ€ workflow with PR reviews.\n\n## Non-Goals\n\nMulti-version docs and i18n in v1.\nAutomated API client generation.\nCustom theming beyond Material configuration.\n\n## Scope\n\nAdd `/docs/` as the single source for narrative docs, guides, and runbooks.\nPublish to a static host (e.g., GitHub Pages) from `main`.\nInclude an **API** section that consumes an OpenAPI file from the repo and renders it as a browsable, searchable reference (tags, endpoints, schemas).\nEnsure dark/light mode, search, copy-code buttons, admonitions, and mobile navigation.\n\n## Information Architecture (initial)\n\n* `index.md` â€” Landing and key entry points.\n* `getting-started.md` â€” Quickstart for local preview and contributions.\n* `architecture/overview.md` â€” System context, key services, data flow.\n* `architecture/services.md` â€” Gateway, Catalog, Search, Embedding, Postgres, Qdrant, MinIO.\n* `operations/local-dev.md` â€” Local development environment basics.\n* `operations/deploy.md` â€” High-level deploy overview.\n* `contributing.md` â€” Authoring standards and review process.\n* `changelog.md` â€” Human-readable highlights.\n* `api/` â€” **OpenAPI documentation site** (see next section).\n\n## OpenAPI Documentation Wiring\n\nThe site must surface the projectâ€™s OpenAPI spec (e.g., `/openapi/openapi.yaml` or `/openapi/openapi.json`) as an interactive API reference under `/api/`.\nThe API page must provide: tag navigation; operation details with request/response schemas; schema/model browsing; server/endpoint selection if defined; and stable deep links to operations and schemas.\nThe API reference must be generated at build time from the spec in the repo, so PRs that change the spec update the published reference automatically.\nIf multiple specs exist (e.g., `gateway`, `catalog`), the `/api/` section must list and route to each spec clearly (e.g., `/api/gateway/`, `/api/catalog/`).\nA â€œDownload specâ€ link must be present for each exposed spec.\nDocument the canonical spec locations (e.g., `/openapi/gateway.yaml`, `/openapi/catalog.yaml`) and require that they remain valid for the build.\n\n## Deliverables\n\nA live docs site reachable at a stable URL.\n`/docs/` folder populated with the IA above.\n`mkdocs.yml` configured for Material theme, repo links, navigation, and search.\nAn `/api/` section that renders the OpenAPI spec(s) from the repo with interactive exploration and deep linking.\nA â€œDocumentationâ€ section in `README` that links to the site and explains how to preview docs locally and contribute via PRs.\n\n## Acceptance Criteria\n\nVisiting the site root shows the Material-styled landing page and working search.\nDark/light mode works, code blocks have copy buttons, and admonitions render correctly.\nThe `/api/` section loads the OpenAPI reference from the repo and supports tag filtering, operation details, schema browsing, and deep links that remain stable after rebuilds.\nChanges to `/docs/**`, `mkdocs.yml`, or `/openapi/**` result in an updated published site.\nThe API page(s) display a visible â€œDownload specâ€ link that returns the exact spec version used to render the page.\n\n## Dependencies\n\nAn OpenAPI spec committed to the repo in a stable path.\nStatic hosting for the generated site and a CI workflow that publishes on merge to `main`.\n\n## Risks\n\nSpec drift or invalid OpenAPI will break the API page; mitigate with CI validation of the spec.\nDocs rot if authoring standards are unclear; mitigate with contributor guidance and PR templates.\n\n## Definition of Done\n\nDocs site is live at the chosen URL with the IA above.\nOpenAPI reference is interactive, up to date, and reachable at `/api/`.\nREADME links to the site and explains how to preview and contribute.\n\n## Takeaways\n\nThis establishes a durable â€œdocs as codeâ€ foundation with strong UX and a first-class API reference tied to the repoâ€™s source of truth.\n\n## Next Steps\n\nConfirm canonical OpenAPI file paths and names.\nAdopt the IA and stub pages.\nEnable CI publish of the site and spec-driven API reference.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-28T11:48:57.637553-04:00","updated_at":"2025-10-28T11:48:57.675008-04:00"}
{"id":"hv-64","title":"Add Google-style docstrings and API docs generation","description":"Add comprehensive Google-style docstrings across all Python files and add configuration/scripts to generate API documentation automatically.\n\nAcceptance criteria:\n- All public functions, classes, and modules in `src/`, `services/`, `shared/`, and `scripts/` have Google-style docstrings (summary, args, returns, raises, examples where appropriate).\n- A docs generation configuration is added using Sphinx (with napoleon) or MkDocs + mkdocstrings and can produce an API site.\n- A small README section describes how to run the docs generation locally (commands) and where generated docs live.\n- The bead includes suggested tooling, review checklist, and scope exclusions (tests, __pycache__, vendored code).\n\nSuggested size: M, priority: P1, labels: [\"type/task\",\"service/docs\",\"risk/low\"].\n\nNotes:\n- Recommend using Sphinx with napoleon extension for Google-style docstrings and autodoc, or MkDocs + mkdocstrings for a lighter setup. Include both options in the bead body so maintainers can choose.\n- Include script/Makefile targets to run the docs build.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.637873-04:00","updated_at":"2025-10-28T11:48:57.676098-04:00"}
{"id":"hv-65","title":"MKDocs integration notes for haven-52 (docstrings + mkdocs)","description":"Update to bead haven-52: ensure the docs generation work is incorporated into the repository's existing MkDocs site.\n\nChanges to include in bead body:\n\n1) mkdocs.yml edits\n- Add a top-level `nav` entry for `API` (or `Reference`) pointing to `api/index.md`.\n- Add `plugins` entries: `- search` and `- mkdocstrings`.\n- Example plugin config snippet:\n\nplugins:\n  - search\n  - mkdocstrings:\n      handlers:\n        python: {}\n\n2) requirements-docs.txt\n- Add the following packages to `requirements-docs.txt`:\n  - mkdocs\n  - mkdocs-material (optional)\n  - mkdocstrings\n  - pymdown-extensions\n  - mkdocs-autoreload (optional for local dev)\n\n3) docs/api/index.md\n- Add an example API page that uses mkdocstrings to document the project:\n\n  ## API Reference\n\n  ::: haven\n      handler: python\n\n  This will include the top-level package `haven`. You can also add targeted modules like `haven.shared`, `haven.services.gateway_api`, etc.\n\n4) Build target / script\n- Add a small script `scripts/build_docs_api.sh` or a Makefile target `docs-api`:\n\n  #!/usr/bin/env bash\n  set -euo pipefail\n  pip install -r requirements-docs.txt\n  mkdocs build\n\n- Optionally `mkdocs build -d site/` to place output where current `site/` expects.\n\n5) CI notes\n- Ensure CI job installs `requirements-docs.txt` and runs `mkdocs build`.\n\n6) Scope \u0026 exclusions\n- Document that tests, `__pycache__`, and vendor directories are excluded.\n\nPlease integrate these details into bead haven-52 so maintainers know exactly what to do and how to validate.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.638108-04:00","updated_at":"2025-10-28T11:48:57.676356-04:00"}
{"id":"hv-66","title":"Remote IMAP Email Collector (epic): ephemeral .eml backfill \u0026 run-scoped cache","description":"Implement an IMAP-based remote collector (MailCore 2) that streams RFC822 bytes to ephemeral .eml files while running, hands them to the existing hostagent .eml/.emlx parser, and deletes the cache directory on exit. Support timeframe-batched backfill (newestâ†’older windows). No POP support.\n\nSize: XL","design":"Deliverables \u0026 design summary:\n\n1) IMAP Collector (Swift, MailCore 2)\n   - Async wrapper `ImapSession` around `MCOIMAPSession` exposing search and fetch APIs.\n   - Auth: pluggable for XOAUTH2 and app-password. Secrets resolved via Keychain `secret_ref`.\n\n2) Ephemeral Cache Manager\n   - Run-scoped root directory (e.g., `~/.Caches/Haven/remote_mail/run-\u003ctimestamp\u003e-\u003cpid\u003e/`).\n   - Atomic write: `.eml.tmp` â†’ `*.eml` rename; parser consumes only finalized `.eml` files.\n   - Enforce `max_mb` (default 100MB) by evicting already-processed files (FIFO/LRU) and tracking on-disk size.\n   - Cleanup stale `run-*` dirs at startup and remove run dir on graceful exit.\n\n3) Backfill Engine\n   - Time-window loop: start with `cursorEnd = now`, compute `cursorStart = cursorEnd - window_days`, then `SEARCH SINCE cursorStart BEFORE cursorEnd` to retrieve UIDs (newestâ†’oldest).\n   - Fetch RFC822 concurrently (bounded concurrency), write to cache, hand each finalized `.eml` to the existing `.eml/.emlx` parser, and delete or mark processed immediately after parser success to keep cache bounded.\n   - Stop when `cursorStart \u003c= stop_at`, or when `max_windows` or `max_messages` reached, or when search returns empty. For providers without reliable date search, fall back to UID-range header fetch while preserving cache bounds.\n\n4) Security\n   - Resolve secrets via Keychain `secret_ref`; do not log secrets or credentials.\n\n5) Docs\n   - Add documentation in the `docs/` tree describing configuration, cache lifecycle, backfill semantics, and provider-specific notes (iCloud/Gmail).\n\nNotes on behavior \u0026 flow:\n- Initialize run dir and size tracker; remove stale runs.\n- For each account/folder: window 0 is newest window; search-\u003efetch-\u003ewrite-\u003estream-\u003edelete; then slide window earlier until stop.\n- Concurrency (configurable) for body fetches to balance throughput and memory.\n\nNext steps (implementation plan):\n1) Implement `ImapSession` async wrapper (search/fetch).\n2) Build `EphemeralCache` (size tracking, tmp-\u003erename, LRU/FIFO deletion, signals cleanup).\n3) Implement `BackfillEngine` (window loop, stop conditions, concurrency limit).\n4) Add docs and sample `hostagent.yml`; run validation tests with iCloud INBOX.","acceptance_criteria":"Acceptance criteria:\n\n1) Resident cache never exceeds `max_mb` Â±5% on-disk when `max_mb: 100` with files deleted as ingestion progresses.\n2) After a successful run, the run dir is fully removed. On abnormal termination, next run removes stale `run-*` dirs before starting.\n3) iCloud IMAP backfill across 3 windows (e.g., 3Ã—7 days) ingests messages newestâ†’older and calls the existing parser for each `.eml`; the collector performs no MIME parsing.\n4) For folders with 500+ messages, the collector completes without OOM and honors the cache cap by chunking/fetching + deletion.\n5) No POP code paths exist in the implementation; IMAP only.\n\nEdge-cases and constraints:\n- Use in-memory per-run Set\u003cUID\u003e per folder to dedupe within a run. Cross-run dedupe is left to downstream catalog (Message-ID + sha256).\n- Crash safety: `.eml.tmp` + rename; stale run cleanup at startup.\n- Providers lacking SEARCH by date: fallback to UID range header fetch with cache bounds preserved.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-28T11:48:57.638324-04:00","updated_at":"2025-10-28T11:48:57.677069-04:00"}
{"id":"hv-67","title":"ImapSession: MailCore2 async wrapper (task)","description":"Implement an async Swift wrapper `ImapSession` around MailCore 2 (`MCOIMAPSession`) that exposes two primary async methods and pluggable auth for XOAUTH2 and app passwords.\n\nDeliverables:\n- `ImapSession` Swift type with:\n  - `searchMessages(folder: String, since: Date?, before: Date?) async throws -\u003e [UInt32]` â€” returns UIDs ordered newestâ†’oldest.\n  - `fetchRFC822(folder: String, uid: UInt32) async throws -\u003e Data` â€” returns full RFC822 bytes.\n- Auth support: XOAUTH2 and app-password; secrets resolved via Keychain `secret_ref` (no logging of secrets).\n- Concurrency-safe implementation suitable for use by BackfillEngine; configurable concurrency limit for fetches.\n- Unit tests covering search -\u003e fetch flow (mocked MailCore session), error handling, and retry/backoff behaviour for transient network errors.\n- Integration example in `hostagent` showing how to call `ImapSession` and fetch a single UID.\n\nAcceptance criteria:\n- `searchMessages` and `fetchRFC822` implemented and documented in code comments.\n- Unit tests exist and pass locally (mocked MailCore responses).\n- The implementation exposes a clear interface usable by `BackfillEngine` and handles auth via Keychain refs.\n- No POP code paths are added.\n\nNotes:\n- Prefer Swift concurrency (async/await) and structured concurrency for parallel fetches.\n- Use safe temporary Data handling; avoid holding large bodies in memory longer than necessary (stream into cache manager when feasible).\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-28T11:48:57.638577-04:00","updated_at":"2025-10-28T11:48:57.677312-04:00"}
{"id":"hv-68","title":"Unit 9 (docs): README_poc.md â€” finalize after units 2/4/5/8","description":"Final POC README with 3â€“4 commands to run and verification steps. This task must wait until Units 2, 4, 5, and 8 are complete.","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-28T11:48:57.638813-04:00","updated_at":"2025-10-28T11:48:57.677534-04:00"}
{"id":"hv-69","title":"EphemeralCache: run-scoped cache manager (task)","description":"Create the EphemeralCache manager used by the remote IMAP collector. The manager creates a run-scoped cache directory, writes `.eml.tmp` then `rename` to `.eml`, tracks on-disk size, enforces `max_mb` via eviction of already-processed files, and removes stale runs on startup.","design":"Deliverables \u0026 design details:\n\n- `EphemeralCache` Swift type (protocol + implementation) with methods:\n  - `init(rootDir: URL, maxMB: Int, processedFilesPolicy: EvictionPolicy)`\n  - `createRunDir() throws -\u003e URL` â€” creates `run-\u003ctimestamp\u003e-\u003cpid\u003e` and returns run root URL.\n  - `writeTemp(uid: UInt32, dataStream: InputStream) -\u003e URL` â€” writes to `\u003cuid\u003e.eml.tmp` atomically streaming to disk.\n  - `finalizeTemp(tempURL: URL) throws -\u003e URL` â€” renames to `\u003cuid\u003e.eml` and updates size accounting.\n  - `markProcessed(emlURL: URL)` â€” mark a file as processed so it becomes eligible for eviction.\n  - `enforceSizeCap() throws` â€” applies FIFO/LRU eviction of processed files until totalSize \u003c= maxMB.\n  - `cleanupOnExit()` â€” removes the run dir on graceful exit.\n  - `cleanupStaleRuns()` â€” removes any leftover `run-*` dirs from previous crashes at startup.\n\n- Concurrency: size accounting and processed-file metadata must be concurrency-safe (use serial DispatchQueue or actor). Provide hooks to stream `.eml` to parser and delete after successful parse.\n- Tempâ†’rename pattern to avoid partial reads; parser only consumes `.eml` files.\n- Eviction policy: default FIFO of processed files; optionally LRU if access timestamps are recorded.\n\nTesting \u0026 validation:\n- Unit tests for writeTemp/finalizeTemp and size accounting.\n- Integration test simulating many small `.eml` files to validate eviction keeps disk usage â‰¤ max_mb Â±5%.\n- Signal handling test to verify cleanupOnExit on SIGINT/SIGTERM (best-effort in unit tests; integration required for full validation).\n\nCI/build notes:\n- No external dependencies required for this component.\n- Document expectations for macOS filesystem paths and permissions.\n","acceptance_criteria":"Acceptance criteria:\n\n1) With `max_mb: 100`, the cache manager keeps on-disk usage â‰¤100MB Â±5% when subjected to simulated writes and processed-file eviction.\n2) Run dir is removed after a normal run (cleanupOnExit called on SIGINT/SIGTERM).\n3) On startup, any stale `run-*` dirs are removed prior to creating a new run dir.\n4) Files are written via `*.eml.tmp` and only visible to parser after rename to `*.eml`.\n5) Processed files are deleted as needed before fetching more to maintain the size cap.\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-28T11:48:57.639037-04:00","updated_at":"2025-10-28T11:48:57.677749-04:00"}
{"id":"hv-7","title":"Hostagent: Stub Contacts collector endpoint","description":"Create stub POST /v1/collectors/contacts:run endpoint for future Contacts.app integration.\n\nTasks:\n- Create ContactsHandler.swift with POST /v1/collectors/contacts:run route\n- Return empty/stub JSON response matching expected schema\n- Add basic error handling and auth\n- Document requirements (pyobjc, TCC permissions) for future implementation\n- Mark as stub/not-implemented in capabilities response\n\nAcceptance:\n- Endpoint exists and returns 200 with stub data\n- Gateway can call it without errors\n- Documentation notes it's a stub for future work","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-27T14:55:24.915679-04:00","updated_at":"2025-10-28T11:48:57.681176-04:00"}
{"id":"hv-70","title":"Gateway: Provide per-account IMAP processed-state API and HostAgent integration","description":"Background\n\nThe HostAgent IMAP run currently persists per-account+folder last-processed UIDs to a local file cache under the configured `mail_imap.cache.dir`. We want the Gateway to be the single source of truth for that state so multiple HostAgent instances (or other workers) can coordinate, and to avoid local-only state that is hard to inspect or migrate.\n\nGoal\n\nAdd a Gateway-backed API and storage for the IMAP per-account processed-state, and update HostAgent to read/write that state from the Gateway instead of the local on-disk cache.\n\nScope / Implementation notes\n\n1. Gateway API\n   - Add endpoints:\n     - GET /v1/imap/state?account_id={id}\u0026folder={folder} -\u003e {\"last_processed_uid\": \u003cint\u003e, \"updated_at\": \"\u003ciso\u003e\"}\n     - POST/PUT /v1/imap/state -\u003e {account_id, folder, last_processed_uid} (idempotent write)\n   - Validate Bearer token (existing Gateway auth middleware) and require internal service token for writes.\n   - Persist state in Gateway DB (new table `imap_account_state`): columns: account_id (text), folder (text), last_processed_uid (integer), updated_at (timestamp), updated_by (optional).\n   - Add simple migrations and an index on (account_id, folder).\n\n2. Gateway backend\n   - Storage adapter in gateway service (catalog or a small new DB table via existing DB layer).\n   - Unit tests for read/write semantics and auth.\n\n3. HostAgent changes\n   - Remove use of local file-based state for IMAP runs.\n   - On IMAP run start, call Gateway GET to fetch last_processed_uid for account+folder.\n   - After each successful submission (or at end of run), call Gateway POST/PUT to update last_processed_uid with the latest processed UID.\n   - Add retry/backoff/fail-safe: if Gateway call fails, HostAgent should log warning and fall back to treating last_processed_uid as 0 (to avoid losing messages) and continue processing â€” but not clobber remote state on write errors.\n\n4. Tests \u0026 docs\n   - Add unit tests for Gateway handlers and HostAgent changes (mock HTTP client in HostAgent tests).\n   - Update `docs/hostagent/email-imap-collector.md` to reflect new behavior and configuration.\n\nAcceptance criteria\n\n- Gateway exposes documented GET/PUT endpoints for IMAP account state and persistently stores state in DB with an index.\n- HostAgent no longer writes/reads per-account IMAP state to local files; instead, it uses the Gateway endpoints.\n- HostAgent includes a safe fallback when Gateway is unreachable (logs and continues without overwriting remote state).\n- Tests exist covering read/write path and a HostAgent test mocking the Gateway API.\n- Docs updated describing the behavior and required Gateway token permissions.\n\nNotes / Risks\n\n- Risk: introducing a single point of failure if Gateway is unavailable; mitigations described above.\n- Backfill/migration: existing local cache files won't be auto-migrated; include a follow-up task to migrate existing local state (optional).\n","acceptance_criteria":"1. Gateway DB schema `imap_account_state(account_id TEXT, folder TEXT, last_processed_uid INTEGER, updated_at TIMESTAMP)` created and migrations added.\n2. Gateway exposes GET and PUT/POST endpoints documented in OpenAPI.\n3. HostAgent uses GET at run start and PUT after successful submissions; tests verify behavior. \n4. HostAgent falls back gracefully if Gateway unavailable and logs appropriate warnings. \n5. Docs updated: `docs/hostagent/email-imap-collector.md` and `mkdocs.yml` reference.\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-28T11:48:57.639296-04:00","updated_at":"2025-10-28T11:48:57.677973-04:00"}
{"id":"hv-71","title":"Extract clean email body text and image captions (strip MIME/HTML cruft)","description":"Problem: Ingested emails currently carry raw MIME/html bodies which include styling, quoted replies, signatures, and other cruft. We need a standardized extraction that captures the meaningful plain-text body and any image captions so downstream indexing/embeddings are higher quality.\n\nGoal: Implement an extractor that, for each submitted email, produces a cleaned plain-text body and a list of image captions (sourced from alt attributes, \u003cfigcaption\u003e, adjacent text, or OCR on attached images as an opt-in step). The extractor should run in the ingestion pipeline so the Catalog stores the cleaned body and captions (not the raw html/mime) alongside existing metadata.\n\nDesign notes:\n- Parse MIME with Python's email library to identify parts.\n- Prefer text/plain. If missing, convert html -\u003e text using a reliable converter (e.g., html2text or bleach + lxml text extraction) and remove boilerplate and inline CSS.\n- Strip quoted reply/forward blocks using heuristics (common separators like \"On .* wrote:\", lines starting with \"\u003e\", and HTML elements with classes/ids commonly used for quoted text).\n- Extract image captions:\n  - from \u003cimg alt=\"...\"\u003e attributes\n  - from \u003cfigure\u003e\u003cfigcaption\u003e...\u003c/figcaption\u003e\u003c/figure\u003e\n  - from text nodes immediately preceding/following img nodes\n  - as an optional worker stage: run OCR on image attachments (controlled by feature flag) and include OCR text as a caption with source=\"ocr\" if no alt/caption found\n- Preserve language metadata and avoid dropping meaningful whitespace or non-latin scripts.\n- Keep it idempotent and safe: do not modify stored original payloads. Add new fields to the document/chunk model as needed (e.g., cleaned_body, image_captions).\n\nAcceptance criteria:\n1) Unit tests: for text/plain, html-only, multipart with inline images (alt + figcaption), and quoted-reply stripping.\n2) Integration test: ingest sample email fixture and verify Catalog (or document record) contains cleaned plain-text snippet and image_captions list.\n3) No changes to original raw MIME payload stored elsewhere. The new fields are additive.\n4) Feature flag or env var to enable/disable OCR (DEFAULT: disabled).\n\nImplementation plan (next steps):\n- Add shared parsing utility in `shared/email_parsing.py` (or existing email utilities) with small functions: parse_mime_parts, html_to_text, strip_quoted, extract_image_captions.\n- Hook into gateway ingestion pipeline to call the extractor before creating document/chunk records.\n- Add unit + integration tests under `test/` using existing fixtures.\n- Add env/config: ENABLE_IMAGE_OCR (false) and doc note.\n\nNotes:\n- Risk: medium (affects ingestion pipeline). Keep changes additive and behind flag if needed.","design":"See description (high level). Implementation should prefer small, well-tested functions and avoid changing public APIs except adding optional fields. For OCR, use existing image_enrichment.py worker pattern; add a job to embed OCR as caption only if ENABLE_IMAGE_OCR=true.","acceptance_criteria":"1) Unit tests for parsing functions pass. 2) Integration test verifies cleaned_body and image_captions exist after ingest. 3) No regressions in existing ingest tests.","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-28T11:48:57.63956-04:00","updated_at":"2025-10-28T11:48:57.678435-04:00"}
{"id":"hv-72","title":"haven-XX: Unified Collector Run API (Normalizer + Router)","description":"Create a single Run API and a Normalizer+Router component in hostagent that owns `/v1/collectors/:name:run`, validates a unified JSON body, normalizes it to a shared DTO, routes to the correct collector adapter (imap, local_mail, imessage), and returns a standard response envelope.\n\nNo legacy/transition support.\n\nUnified Request (all collectors):\n\n{\n  \"mode\": \"run|dry_run|tail|backfill\",\n  \"limit\": 0,\n  \"batch_size\": 500,\n  \"order\": \"asc|desc\",\n  \"time_window\": { \"lookback_days\": 30, \"thread_lookback_days\": 90 },\n  \"date_range\": { \"since\": \"2025-01-01T00:00:00Z\", \"until\": \"2025-02-01T00:00:00Z\" },\n  \"reset\": false,\n  \"concurrency\": 4,\n  \"dry_run\": false,\n  \"source_overrides\": {},\n  \"credentials\": { \"kind\": \"\", \"secret\": \"\", \"secret_ref\": \"\" }\n}\n\nStandard Response:\n\n{\n  \"status\": \"ok|error|partial\",\n  \"collector\": \"imessage|email_imap|email_local\",\n  \"run_id\": \"â€¦\",\n  \"started_at\": \"â€¦\",\n  \"finished_at\": \"â€¦\",\n  \"stats\": {\n    \"scanned\": 0, \"matched\": 0, \"submitted\": 0, \"skipped\": 0,\n    \"earliest_touched\": \"â€¦\", \"latest_touched\": \"â€¦\", \"batches\": 0\n  },\n  \"warnings\": [], \"errors\": []\n}\n\nDeliverables:\n- hostagent/Collectors/RunRouter.swift â€” HTTP handler for /v1/collectors/:name:run; validates â†’ normalizes â†’ routes.\n- hostagent/Collectors/CollectorRunRequest.swift â€” shared DTO + JSON decoding + schema validation.\n- hostagent/Collectors/RunResponse.swift â€” standard response envelope + timing helpers.\n\nAdapters:\n- ImapRunAdapter.swift â†’ maps to ImapRunRequest (supports: account_id, folder, max_limit, before; concurrency, reset, dry_run).\n- LocalMailRunAdapter.swift â†’ maps to Local RunRequest (supports: source_path; order/since/until; dry_runâ†’simulate).\n- IMessageRunAdapter.swift â†’ maps to iMessage params; supports optional date_range + order, thread_lookback_days.\n- schemas/collector_run_request.schema.json â€” JSON Schema for request validation.\n- Tests: golden req/resp for each collector + failure cases (schema errors, invalid enums).\n\nAcceptance Criteria:\n1. A single route /v1/collectors/:name:run accepts only the unified body and rejects unknown fields.\n2. If date_range present, it overrides time_window selection semantics.\n3. order honored by IMAP/Local and by iMessage (default DESC when not provided).\n4. Response uses the standard envelope for all collectors with accurate stats and timings.\n5. Unit tests pass; end-to-end smoke tests succeed for each collector.\n\nNon-goals: No legacy field parsing, no deprecation layer, no client-side shims.\n\nImplementation Plan:\n1. Schema \u0026 DTO: Add JSON Schema; implement CollectorRunRequest with strict decoding (fail on unknowns).\n2. Router: Implement RunRouter to parse collector name, validate body, build DTO, and dispatch to adapter.\n3. Adapters:\n   â€¢ IMAP: map unified â†’ ImapRunRequest; compute since from lookback_days if no date_range.\n   â€¢ Local: map unified â†’ Local RunRequest; dry_run triggers simulate path if source_path provided.\n   â€¢ iMessage: extend handler to accept optional since/until + order, else fall back to lookbacks.\n4. Response: Normalize each handlerâ€™s result into RunResponse; include durations and batch counts.\n5. Tests: Table-driven tests per adapter; schema rejection tests; end-to-end route tests.\n\nNotes:\n- Keep concurrency clamped (1..12) centrally in the normalizer.\n- Use ISO-8601 UTC for all timestamps.\n","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-28T11:48:57.639832-04:00","updated_at":"2025-10-28T11:48:57.678707-04:00"}
{"id":"hv-73","title":"Tests: unit + end-to-end smoke for Run API and adapters","description":"Add tests for the Collector Run API and adapters.\n\nTests to add:\n- Unit tests for `CollectorRunRequest` decoding and schema rejections (unknown fields, bad enums).\n- Table-driven unit tests for each adapter mapping (IMAP, Local, iMessage) with golden req/resp.\n- Route-level end-to-end smoke tests for `/v1/collectors/:name:run` asserting standard response envelope, status, and stats.\n\nAcceptance criteria:\n- Tests added under `test/` and `tests/` as appropriate; CI should run them; provide example fixture files under `test/fixtures/collectors/`.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.640077-04:00","updated_at":"2025-10-28T11:48:57.67894-04:00"}
{"id":"hv-74","title":"Docs \u0026 examples: collectors_run_api.md + fixtures","description":"Add documentation and example fixtures for the unified collectors Run API.\n\nArtifacts:\n- `docs/hostagent/collectors_run_api.md` with schema overview, example requests/responses, and notes about concurrency clamp and date precedence.\n- Example fixtures in `test/fixtures/collectors/` (golden requests/responses for each collector and schema error examples).\n\nAcceptance criteria:\n- Docs page created and fixtures available for tests and developer reference.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.640316-04:00","updated_at":"2025-10-28T11:48:57.679155-04:00"}
{"id":"hv-75","title":"Clamp concurrency centrally in normalizer/DTO","description":"Implement central concurrency clamp (1..12) in the `CollectorRunRequest` normalizer so all adapters inherit the limit.\n\nTasks:\n- Enforce clamp during decode/normalization; if out of range, clamp and log a warning; tests for values \u003c1 and \u003e12.\n- Document behavior in `docs/hostagent/collectors_run_api.md`.\n\nAcceptance criteria:\n- Concurrency values are clamped and unit tests verify clamping and warning emission.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.640578-04:00","updated_at":"2025-10-28T11:48:57.679358-04:00"}
{"id":"hv-76","title":"CI / Quality gates: run tests \u0026 fix issues for Run API","description":"Run unit tests and CI checks for changes related to the unified Run API and ensure the codebase remains green.\n\nTasks:\n- Run `pytest` and fix any failing tests introduced by the new code.\n- Address linting/type errors in hostagent files touched.\n- Add CI job updates if needed to include new test fixtures.\n- Ensure commit messages include `Refs: beads:#haven-71` when landing PRs.\n\nAcceptance criteria:\n- Tests pass locally for the modified hostagent code; CI job(s) run and pass; any remaining failures documented with remediation steps.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.640795-04:00","updated_at":"2025-10-28T11:48:57.67957-04:00"}
{"id":"hv-77","title":"Epic: Finish Hostagent â€” build, run, test, and integrate","description":"Complete the Hostagent native macOS service so it can be built, installed, run as a LaunchAgent, collect iMessage/contact/fs data, perform Vision OCR, and integrate reliably with Gateway and Neo4j POC. Include tests and documentation.\n\nScope/Checklist:\n- Build and packaging: `make install`, `make run`, `make dev`, `make launchd` documented and working on macOS.\n- Collectors: iMessage, Contacts, localfs collectors updated to use hostagent API; deprecated Python collectors marked.\n- OCR/vision: integrate native Vision OCR endpoint `/v1/ocr` and replace legacy `imdesc.swift` usage.\n- FS watch: FSEvents-based uploads with presigned URL flows to Gateway/minio.\n- Gateway integration: Gateway POC routes (`/poc/hostagent/run`, `/poc/hostagent/status`) fully functional and tested end-to-end.\n- Neo4j POC: ensure hostagent-produced entities can be ingested into Gateway -\u003e Neo4j flow.\n- Tests: unit tests for hostagent logic, and an end-to-end smoke test that simulates collectors with `--simulate` and verifies Gateway ingestion.\n- Docs: `hostagent/QUICKSTART.md` and update `AGENTS.md` with final run instructions and TCC/FDA notes.\n\nAcceptance criteria:\n- Hostagent builds and installs locally on macOS via `make install`.\n- `make launchd` successfully installs a user LaunchAgent and `make health` returns 200.\n- End-to-end simulated collector run posts data to Gateway and the Gateway accepts it (200) in CI-like dry-run.\n- All new/changed functionality covered by unit tests; `pytest` passes for hostagent/test files.\n\nNotes:\n- This epic may depend on Units 2/4/5 for catalog/contact exports and span mapping for precise attribution.\n- Use existing `hostagent/Makefile` and follow `hostagent/QUICKSTART.md` conventions.\n","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-28T11:48:57.641006-04:00","updated_at":"2025-10-28T11:48:57.679791-04:00"}
{"id":"hv-78","title":"Epic: Finish Hostagent â€” build, run, test, and integrate","description":"Complete the Hostagent native macOS service so it can be built, installed, run as a LaunchAgent, collect iMessage/contact/fs data, perform Vision OCR, and integrate reliably with Gateway and Neo4j POC. Include tests and documentation.\n\nScope/Checklist:\n- Build and packaging: `make install`, `make run`, `make dev`, `make launchd` documented and working on macOS.\n- Collectors: iMessage, Contacts, localfs collectors updated to use hostagent API; deprecated Python collectors marked.\n- OCR/vision: integrate native Vision OCR endpoint `/v1/ocr` and replace legacy `imdesc.swift` usage.\n- FS watch: FSEvents-based uploads with presigned URL flows to Gateway/minio.\n- Gateway integration: Gateway POC routes (`/poc/hostagent/run`, `/poc/hostagent/status`) fully functional and tested end-to-end.\n- Neo4j POC: ensure hostagent-produced entities can be ingested into Gateway -\u003e Neo4j flow.\n- Tests: unit tests for hostagent logic, and an end-to-end smoke test that simulates collectors with `--simulate` and verifies Gateway ingestion.\n- Docs: `hostagent/QUICKSTART.md` and update `AGENTS.md` with final run instructions and TCC/FDA notes.\n\nAcceptance criteria:\n- Hostagent builds and installs locally on macOS via `make install`.\n- `make launchd` successfully installs a user LaunchAgent and `make health` returns 200.\n- End-to-end simulated collector run posts data to Gateway and the Gateway accepts it (200) in CI-like dry-run.\n- All new/changed functionality covered by unit tests; `pytest` passes for hostagent/test files.\n\nNotes:\n- This epic may depend on Units 2/4/5 for catalog/contact exports and span mapping for precise attribution.\n- Use existing `hostagent/Makefile` and follow `hostagent/QUICKSTART.md` conventions.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-28T11:48:57.641243-04:00","updated_at":"2025-10-28T11:48:57.680243-04:00"}
{"id":"hv-79","title":"hostagent: validate \u0026 consolidate hostagent.yaml format","description":"Double-check, clean up, and consolidate the `hostagent.yaml` configuration format used by HostAgent. This task will: 1) review the current `.tmp/hostagent.bak.yaml` (provided by user) and any other hostagent config examples; 2) produce a single canonical `hostagent.yaml` schema (keys, types, defaults); 3) merge and clean duplicate/legacy keys; 4) add simple validation (schema or unit tests) and update docs so other contributors follow the canonical format.","design":"- Inspect `.tmp/hostagent.bak.yaml` and `hostagent/` config files for variations.\n- Propose canonical schema (YAML keys, types, defaults) in the bead body or a small design doc.\n- Implement schema file (e.g., `hostagent/hostagent.schema.yaml`) or unit tests under `test/` that validate example configs.\n- Update `docs/` (or create `.tmp/` doc) describing canonical format and migration notes.\n- Small follow-up PR to apply changes and add tests.","acceptance_criteria":"- Canonical `hostagent.yaml` schema documented and committed.\n- At least one unit test or schema validation that fails on an invalid sample and passes for the canonical sample.\n- Documentation updated with example config and migration steps.\n- Created PR referencing this bead and `Refs: beads:#\u003cid\u003e` on commit(s).","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.641472-04:00","updated_at":"2025-10-28T11:48:57.680468-04:00"}
{"id":"hv-8","title":"Hostagent: Port macOS Contacts collector (collector_contacts.py) to Swift","description":"Port the Python Contacts collector (`scripts/collectors/collector_contacts.py`) into the native Hostagent Swift service as a collector endpoint.\n\nScope/Tasks:\n- Add `POST /v1/collectors/contacts:run` and `GET /v1/collectors/contacts/state` endpoints in hostagent.\n- Implement safe access to macOS Contacts (CNContactStore) and mapping to the existing PersonIngestRecord/gateway schema.\n- Implement batching and backoff to POST to Gateway `/catalog/contacts/ingest` (support simulate mode for CI).\n- Add option to run in `simulate` mode (no FDA required), and a `limit` parameter for testing.\n- Handle photo hashing (SHA256) and label localization (reusing `localizedStringForLabel:` like the Python version).\n- Add robust error handling and state persistence to `~/.haven/contacts_collector_state.json`.\n- Add unit tests and fixtures (small set of representative contacts) and update `hostagent/QUICKSTART.md` and `AGENTS.md` with the new endpoints.\n\nAcceptance Criteria:\n- `POST /v1/collectors/contacts:run` returns valid JSON with `status` and `people` when run in simulate mode.\n- Hostagent can run mount-based collection with FDA when run locally and return full person records matching current Python collector schema.\n- Batching to Gateway works and respects `CONTACTS_BATCH_SIZE` env var; use backoff/retries on transient HTTP errors.\n- Unit tests exercise parsing logic and photo hash computation.\n\nNotes:\n- The script `scripts/collectors/collector_contacts.py` is attached in the issue for reference.\n- Label this task `service/hostagent`, `type/task`, `risk/med`.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:55:28.95007-04:00","updated_at":"2025-10-27T14:55:28.95007-04:00"}
{"id":"hv-80","title":"Add OpenAPI exporter endpoint to HostAgent runtime","description":"Goal\nAdd a canonical, runtime OpenAPI exporter to the HostAgent Swift service so the service can serve its OpenAPI spec (JSON and/or YAML) and be the single source-of-truth for API docs. This will eliminate spec drift and allow automation (mkdocs/exporter) to fetch the live spec during docs builds or CI.\n\nBackground\nCurrently the repo contains a static `openapi/hostagent.yaml` authored by hand and a Python exporter that writes a Redoc page for it. HostAgent is a macOS-native Swift service; there is no runtime OpenAPI endpoint. That produces drift risk when new routes or request/response schemas are added in Swift.\n\nScope\n- Add an endpoint to HostAgent that exposes the service's OpenAPI specification at `/openapi.json` and `/openapi.yaml` (YAML optional). The endpoint should be enabled in dev/build configurations and guarded behind admin or local-only access in production if required by config.\n- Generate OpenAPI programmatically from the HostAgent router/handlers and bundled JSON schemas in `Resources/*/schemas/*.schema.json` (merge those into components.schemas). If full programmatic generation is infeasible, provide a build-time task that composes the OpenAPI spec from route metadata + JSON schemas and writes a file to `Resources/OpenAPI/hostagent.yaml` that the server serves statically.\n- Ensure the exporter includes the Collector routes, email utilities, FSWatch, face detection, OCR, entities, modules, metrics, and health endpoints already present in the router.\n- Add minimal tests that exercise the endpoint and verify the presence of key paths and the `CollectorRunRequest` schema in components.\n- Update docs/dev workflow: the Python `scripts/export_openapi.py` (or docs hooks) can optionally fetch the runtime `/openapi.yaml` (if server running) or read the build-time generated `Resources/OpenAPI/hostagent.yaml` during docs builds/CI.\n\nDesign notes\n- Runtime approach (preferred long-term): implement a small OpenAPI-builder utility in Swift that walks the Router/PatternRouteHandler registrations and collects path patterns, methods, and handler metadata. For each route, include a path entry with sensible default request/response schemas, and resolve component schemas by importing JSON schema files from Resources.\n  - Expose endpoints: `/openapi.json` and `/openapi.yaml` (Content-Type application/json / application/x-yaml).\n  - Add a config toggle: `openapi.enabled: true|false`, default true in dev, false in production unless explicitly enabled.\n  - Secure the endpoint optionally with the hostagent auth header (configurable) or limit to localhost only.\n\n- Build-time fallback (lower risk): add a Swift PackageTarget/tool that generates `Resources/OpenAPI/hostagent.yaml` from the same route discovery utility and schema files. Add a Makefile or SPM run target `swift run hostagent-openapi --emit-resources` to write the file into `Resources/OpenAPI/` which will be bundled and served as static files.\n\nAcceptance criteria\n- The HostAgent binary serves an OpenAPI spec at `/openapi.yaml` when `openapi.enabled` is true (or the generated resource file exists). The spec includes paths for collectors (including `imessage` and `email_imap`) and contains `components.schemas.CollectorRunRequest` matching the JSON schema in `Resources/Collectors/schemas/collector_run_request.schema.json`.\n- Unit/integration test that makes a local request to `/openapi.yaml` and asserts the spec contains `/v1/collectors/imessage:run` and `components.schemas.CollectorRunRequest`.\n- `scripts/export_openapi.py` can optionally be updated to fetch the runtime `/openapi.yaml` (if server available) during docs builds â€” documented in the README/dev docs.\n\nImplementation tasks\n1. Add a new Swift module `HostOpenAPI` or utility inside HostAgent to build the spec.\n2. Implement route-walker that introspects `Router` / `PatternRouteHandler` registrations.\n3. Merge JSON schemas from `Resources/**/schemas/*.schema.json` into `components.schemas`.\n4. Expose endpoints `/openapi.json` and `/openapi.yaml` (serve YAML by converting internal JSON using a YAML serializer or pre-generate YAML at build time).\n5. Add config flag to enable/disable endpoint and optional local-only/auth restrictions.\n6. Add tests covering presence of key paths and schemas.\n7. Optional: update `scripts/export_openapi.py` doc/comments to support fetching runtime spec.\n\nNotes / Risks\n- Programmatic route introspection in Swift depends on the router implementation. If introspection is not possible, the build-time generator fallback will be used.\n- Care must be taken to not leak sensitive data (authentication headers, internal endpoints). Default to local-only in production.\n\nEstimate\n- Design + prototype: 1â€“2 days\n- Implementation + tests + docs: 2â€“4 days\n\n","design":"See description above for runtime vs build-time designs. Prefer runtime exporter with config toggle; fallback to build-time generator if introspection is impractical.","acceptance_criteria":"- HostAgent serves /openapi.yaml when enabled.\n- The YAML contains `/v1/collectors/imessage:run` and `components.schemas.CollectorRunRequest` matching the repo JSON schema.\n- Tests added and passing.\n- Docs updated to describe how to fetch the runtime spec and how mkdocs/docs exporter can use it.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-28T11:48:57.641723-04:00","updated_at":"2025-10-28T11:48:57.680694-04:00"}
{"id":"hv-81","title":"Hostagent: Port macOS Contacts collector (collector_contacts.py) to Swift","description":"Port the Python Contacts collector (`scripts/collectors/collector_contacts.py`) into the native Hostagent Swift service as a collector endpoint.\n\nScope/Tasks:\n- Add `POST /v1/collectors/contacts:run` and `GET /v1/collectors/contacts/state` endpoints in hostagent.\n- Implement safe access to macOS Contacts (CNContactStore) and mapping to the existing PersonIngestRecord/gateway schema.\n- Implement batching and backoff to POST to Gateway `/catalog/contacts/ingest` (support simulate mode for CI).\n- Add option to run in `simulate` mode (no FDA required), and a `limit` parameter for testing.\n- Handle photo hashing (SHA256) and label localization (reusing `localizedStringForLabel:` like the Python version).\n- Add robust error handling and state persistence to `~/.haven/contacts_collector_state.json`.\n- Add unit tests and fixtures (small set of representative contacts) and update `hostagent/QUICKSTART.md` and `AGENTS.md` with the new endpoints.\n\nAcceptance Criteria:\n- `POST /v1/collectors/contacts:run` returns valid JSON with `status` and `people` when run in simulate mode.\n- Hostagent can run mount-based collection with FDA when run locally and return full person records matching current Python collector schema.\n- Batching to Gateway works and respects `CONTACTS_BATCH_SIZE` env var; use backoff/retries on transient HTTP errors.\n- Unit tests exercise parsing logic and photo hash computation.\n\nNotes:\n- The script `scripts/collectors/collector_contacts.py` is attached in the issue for reference.\n- Label this task `service/hostagent`, `type/task`, `risk/med`.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.64373-04:00","updated_at":"2025-10-28T11:48:57.681385-04:00"}
{"id":"hv-82","title":"HostAgent: Make collector polling intervals configurable (iMessage, LocalFS, Contacts)","description":"Add configuration and runtime controls to set polling intervals for HostAgent collectors (iMessage, LocalFS, Contacts, and any future collectors).\\n\\nBackground:\\nHostAgent currently runs collectors on fixed schedules. Operators need the ability to tune polling frequency per-collector to balance CPU/IO, battery, and timeliness. This task adds config, runtime endpoints, and documentation.\\n\\nAcceptance criteria:\\n- Add per-collector polling interval configuration via: 1) `hostagent.yaml` config file (per-collector keys), 2) environment variables `HOSTAGENT_\u003cCOLLECTOR\u003e_POLL_INTERVAL_SEC`, and 3) CLI flags for simulate/test runs.\\n- Implement runtime endpoints: `GET /v1/collectors/{collector}/poll_interval` and `POST /v1/collectors/{collector}/poll_interval` to view and update the interval without restart. POST accepts `{ \"interval_seconds\": \u003cnumber\u003e }` and validates min/max bounds.\\n- Ensure iMessage, LocalFS, and Contacts collectors read the effective interval and apply it for scheduling/backoff; new collectors should reuse the same scheduling helper.\\n- Validate that changes via environment, config file, and runtime API follow this precedence: API update \u003e env var \u003e config file \u003e default (60s). Document this precedence in `AGENTS.md` and `hostagent/QUICKSTART.md`.\n- Add unit tests for scheduling helper and integration tests that simulate changing the poll interval at runtime and confirm the collector respects the new interval within one cycle.\n- Add labels: `service/hostagent`, `type/task`, `risk/low`, `priority:P2`.\n\\nNotes:\\n- Use sensible min/max (min 5s, max 86400s = 1 day) and defensive validation.\\n- Prefer a small, shared scheduling utility that emits schedule ticks and supports update at runtime and backoff.\\n- Keep changes backwards compatible; default behavior remains current schedule if no config provided.\\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T11:48:57.644001-04:00","updated_at":"2025-10-28T11:48:57.681604-04:00"}
{"id":"hv-83","title":"Compile MailCore2 for Apple Silicon (ARM64) support","description":"Remove the requirement for `arch -x86_64` prefixes by compiling MailCore2 with native ARM64 support or finding an ARM64-compatible alternative.\n\n## Problem\nThe current MailCore2 dependency (`https://github.com/MailCore/mailcore2.git`) only ships as an x86_64 framework, requiring all Swift build/test commands to use `arch -x86_64` prefix. This creates:\n- Performance overhead from Rosetta translation\n- Complex development workflow with architecture prefixes\n- Potential CI/CD complications\n- Poor developer experience on Apple Silicon Macs\n\n## Current Workaround\nAll build commands in `hostagent/Makefile` use `arch -x86_64`:\n```makefile\nbuild:\n\tarch -x86_64 swift build\ntest:\n\tarch -x86_64 swift test\n```\n\n## Goals\n- Enable native ARM64 compilation of hostagent\n- Remove `arch -x86_64` prefixes from Makefile\n- Maintain full IMAP functionality (search, fetch, auth)\n- Improve developer experience and performance\n\n## Implementation Options\n\n### Option 1: Fork and Build MailCore2 for ARM64\n- Fork the MailCore2 repository\n- Add ARM64 build configuration\n- Update Package.swift to use the forked version\n- Test IMAP functionality thoroughly\n\n### Option 2: Find ARM64-Compatible Alternative\n- Research alternative Swift IMAP libraries with ARM64 support\n- Evaluate compatibility with existing ImapSession implementation\n- Migrate if suitable alternative found\n\n### Option 3: Build MailCore2 from Source\n- Investigate building MailCore2 from source with ARM64 support\n- Create build scripts for ARM64 compilation\n- Package as local dependency\n\n## Acceptance Criteria\n1. `swift build` and `swift test` work without `arch -x86_64` prefix on Apple Silicon\n2. All IMAP functionality (searchMessages, fetchRFC822) works on native ARM64\n3. Makefile updated to remove architecture prefixes\n4. Documentation updated to remove Rosetta requirements\n5. CI/CD pipelines work without architecture workarounds\n6. Performance is equal or better than Rosetta-based builds\n\n## Testing\n- Verify IMAP search and fetch operations work correctly\n- Test with real IMAP servers (iCloud, Gmail)\n- Ensure XOAUTH2 and app-password auth still function\n- Run full test suite on ARM64\n- Performance benchmarking vs Rosetta builds\n\n## Documentation Updates\n- Update `docs/hostagent/email-imap-collector.md` to remove Rosetta requirements\n- Update `hostagent/README.md` build instructions\n- Update any CI/CD documentation\n\n## Risks\n- MailCore2 ARM64 build may have compatibility issues\n- Alternative libraries may lack required features\n- Breaking changes in IMAP functionality\n- Increased build complexity\n\n## Dependencies\n- None (can be worked on independently)\n\n## Notes\n- Current ImapSession implementation is well-tested and should be preserved\n- Consider creating a compatibility layer if switching libraries\n- May need to update Package.resolved and dependency management","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-28T12:27:35.623053-04:00","updated_at":"2025-10-28T12:27:35.623053-04:00"}
{"id":"hv-9","title":"HostAgent: Make collector polling intervals configurable (iMessage, LocalFS, Contacts)","description":"Add configuration and runtime controls to set polling intervals for HostAgent collectors (iMessage, LocalFS, Contacts, and any future collectors).\n\nBackground:\nHostAgent currently runs collectors on fixed schedules. Operators need the ability to tune polling frequency per-collector to balance CPU/IO, battery, and timeliness. This task adds config, runtime endpoints, and documentation.\n\nAcceptance criteria:\n- Add per-collector polling interval configuration via: 1) `hostagent.yaml` config file (per-collector keys), 2) environment variables `HOSTAGENT_\u003cCOLLECTOR\u003e_POLL_INTERVAL_SEC`, and 3) CLI flags for simulate/test runs.\n- Implement runtime endpoints: `GET /v1/collectors/{collector}/poll_interval` and `POST /v1/collectors/{collector}/poll_interval` to view and update the interval without restart. POST accepts `{ \"interval_seconds\": \u003cnumber\u003e }` and validates min/max bounds.\n- Ensure iMessage, LocalFS, and Contacts collectors read the effective interval and apply it for scheduling/backoff; new collectors should reuse the same scheduling helper.\n- Validate that changes via environment, config file, and runtime API follow this precedence: API update \u003e env var \u003e config file \u003e default (60s). Document this precedence in `AGENTS.md` and `hostagent/QUICKSTART.md`.\n- Add unit tests for scheduling helper and integration tests that simulate changing the poll interval at runtime and confirm the collector respects the new interval within one cycle.\n- Add labels: `service/hostagent`, `type/task`, `risk/low`, `priority:P2`.\n\nNotes:\n- Use sensible min/max (min 5s, max 86400s = 1 day) and defensive validation.\n- Prefer a small, shared scheduling utility that emits schedule ticks and supports update at runtime and backoff.\n- Keep changes backwards compatible; default behavior remains current schedule if no config provided.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-27T14:55:32.695072-04:00","updated_at":"2025-10-27T14:55:32.695072-04:00"}
